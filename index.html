<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Hexo</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hexo</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/02/07/%E5%A4%A7%E6%95%B0%E6%8D%AE/Atlas%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/07/%E5%A4%A7%E6%95%B0%E6%8D%AE/Atlas%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D/" class="post-title-link" itemprop="url">Atlas简单介绍</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-02-07 16:39:05 / Modified: 17:00:30" itemprop="dateCreated datePublished" datetime="2023-02-07T16:39:05+08:00">2023-02-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%88%86%E7%B1%BB/" itemprop="url" rel="index"><span itemprop="name">大数据分类</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%88%86%E7%B1%BB/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%AD%90%E5%88%86%E7%B1%BB/" itemprop="url" rel="index"><span itemprop="name">大数据子分类</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>这里填写摘要。也可以把摘要这一段删去，在文章中想要截断的地方加入<!--more-->，这样在首页就只显示开头到截断的内容，而不会显示全文</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/02/07/%E5%A4%A7%E6%95%B0%E6%8D%AE/Atlas%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D/">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/02/04/yuque/consul/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/04/yuque/consul/" class="post-title-link" itemprop="url">consul</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-04 16:07:09" itemprop="dateCreated datePublished" datetime="2023-02-04T16:07:09+08:00">2023-02-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-02-07 21:27:12" itemprop="dateModified" datetime="2023-02-07T21:27:12+08:00">2023-02-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="https://cdn.jsdelivr.net/gh/heheii/blog-imag/blog-images/FkQzi14_daTk2E4nXJ1DJDv0wfIH.png"></p>
<ul>
<li>Consul 支持多数据中心，在上图中有两个数据中心(DateCenter)，数据中心之间通过 Internet 互联，为了提高通信效率，只有 Server 节点才能加入跨数据中心的通信。</li>
<li>在单个数据中心中，Consul 分为 Client 和 Server 两种节点(所有的节点被称为 Agent)。<ul>
<li>Server 节点保存数据，推荐数量是 3 个或者 5 个；</li>
<li>Client 节点负责健康检查及转发数据请求到 Server。</li>
</ul>
</li>
<li>Server 节点包含一个 Leader 和多个 Follower,Leader 节点会将数据同步到 Follower，在 Leader 挂掉的时候会启动选举机制产生一个新的 Leader。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/01/18/yuque/Atlas%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/18/yuque/Atlas%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D/" class="post-title-link" itemprop="url">Atlas简单介绍</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-01-18 16:12:42" itemprop="dateCreated datePublished" datetime="2023-01-18T16:12:42+08:00">2023-01-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-02-07 21:27:16" itemprop="dateModified" datetime="2023-02-07T21:27:16+08:00">2023-02-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>Atlas 是一组可伸缩和可扩展的核心基础治理服务——使企业能够有效且高效地满足其在 Hadoop 中的合规性要求，并允许与整个企业数据生态系统集成。<br>Apache Atlas 为组织提供开放的元数据管理和治理功能，以构建其数据资产的目录，对这些资产进行分类和治理，并为数据科学家、分析师和数据治理团队提供围绕这些数据资产的协作能力。</p>
<h1 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h1><p>元数据管理<br>数据血缘查询<br>审计</p>
<h1 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h1><p><img src="https://cdn.jsdelivr.net/gh/heheii/blog-imag/blog-images/Foz_hdn5PfKuiRBvJ7G9CowzgS-L.png"></p>
<h1 id="Atlas-获取元数据方式"><a href="#Atlas-获取元数据方式" class="headerlink" title="Atlas 获取元数据方式"></a>Atlas 获取元数据方式</h1><p>/opt/module/atlas/hook-bin/import-hive.sh 该脚本同步全量数据<br>通过配置的 hook 同步增量数据（sources -&gt; kafka -&gt; core -&gt; store）</p>
<h1 id="Integration"><a href="#Integration" class="headerlink" title="Integration"></a>Integration</h1><h2 id="Messaging"><a href="#Messaging" class="headerlink" title="Messaging"></a>Messaging</h2><p>topic-ATLAS_HOOK:<br>来自各个组件的 Hook 的元数据通知事件通过写入到名为 ATLAS_HOOK 的 Kafka topic 发送到 Atlas.<br>topic-ATLAS_ENTITIES：<br>从 Atlas 到其他集成组件（如 Ranger）的事件写入到名为 ATLAS_ENTITIES 的 Kafka topic</p>
<h2 id="API"><a href="#API" class="headerlink" title="API"></a>API</h2><p><a target="_blank" rel="noopener" href="https://atlas.apache.org/api/v2/ui/index.html#/">https://atlas.apache.org/api/v2/ui/index.html#/</a></p>
<h1 id="Core"><a href="#Core" class="headerlink" title="Core"></a>Core</h1><h2 id="Type-System"><a href="#Type-System" class="headerlink" title="Type System"></a>Type System</h2><p>Atlas 允许用户为他们想要管理的元数据对象定义一个模型。该模型由称为“types” 的定义组成。“types” （类）的实例被称为 “entities” 表示被管理的实际元数据对象</p>
<h2 id="Graph-Engine"><a href="#Graph-Engine" class="headerlink" title="Graph Engine"></a>Graph Engine</h2><p>在内部，Atlas 通过使用图模型管理元数据对象。以实现元数据对象之间的巨大灵活性和丰富的关系。图形引擎是负责在类型系统的类型和实体之间进行转换的组件，以及基础图形模型。<br>除了管理图形对象之外，图形引擎还为元数据对象创建适当的索引，以便有效地搜索它们</p>
<h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><h2 id="Glossary"><a href="#Glossary" class="headerlink" title="Glossary"></a><strong>Glossary</strong></h2><p>词汇表为业务用户提供适当的词汇表，它允许术语（单词）彼此相关并进行分类，以便在不同的上下文中可以理解它们。然后可以将这些术语映射到数据库、表、列等资产。这有助于抽象化与存储库相关的技术术语，并允许用户发现/使用他们更熟悉的词汇表中的数据。</p>
<h2 id="Classification-Propagation"><a href="#Classification-Propagation" class="headerlink" title="Classification Propagation"></a>Classification Propagation</h2><ul>
<li>分类传播使与实体相关联的分类能够自动与该实体的其他相关实体相关联。这在处理数据集从其他数据集派生数据的场景时非常有用——比如在文件中加载数据的表，从表/视图生成的报告等。</li>
<li>例如，当一个表被归类为<em>PII</em>时，从该表派生数据的表或视图将被自动归类为<em>PII</em>。</li>
<li><img src="https://cdn.jsdelivr.net/gh/heheii/blog-imag/blog-images/Fh_R29vfYGZx9nTwqQWMqL2QgQD4.png"></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/01/18/yuque/Atlas%E5%AE%89%E8%A3%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/18/yuque/Atlas%E5%AE%89%E8%A3%85/" class="post-title-link" itemprop="url">Atlas安装</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-01-18 16:10:54" itemprop="dateCreated datePublished" datetime="2023-01-18T16:10:54+08:00">2023-01-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-02-07 21:27:16" itemprop="dateModified" datetime="2023-02-07T21:27:16+08:00">2023-02-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="1-Solr-安装"><a href="#1-Solr-安装" class="headerlink" title="1. Solr 安装"></a>1. Solr 安装</h1><p>需要在三个节点都执行</p>
<h2 id="1-1-创建系统用户-solr"><a href="#1-1-创建系统用户-solr" class="headerlink" title="1.1 创建系统用户 solr"></a>1.1 创建系统用户 solr</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo useradd solr</span><br><span class="line">echo solr | sudo passwd --stdin solr</span><br></pre></td></tr></table></figure>

<h2 id="1-2-上传-solr-安装包-solr-7-7-3-tgz，并解压到-opt-module-目录，重命名为-solr"><a href="#1-2-上传-solr-安装包-solr-7-7-3-tgz，并解压到-opt-module-目录，重命名为-solr" class="headerlink" title="1.2 上传 solr 安装包 solr-7.7.3.tgz，并解压到/opt/module 目录，重命名为 solr"></a>1.2 上传 solr 安装包 solr-7.7.3.tgz，并解压到/opt/module 目录，重命名为 solr</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf solr-7.7.3.tgz -C /opt/module/</span><br><span class="line">cd /opt/module</span><br><span class="line">mv solr-7.7.3/ solr</span><br></pre></td></tr></table></figure>

<h2 id="1-3-修改-solr-目录的所有者为-solr-用户"><a href="#1-3-修改-solr-目录的所有者为-solr-用户" class="headerlink" title="1.3 修改 solr 目录的所有者为 solr 用户"></a>1.3 修改 solr 目录的所有者为 solr 用户</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chown -R solr:solr /opt/module/solr</span><br></pre></td></tr></table></figure>

<h2 id="1-4-修改-solr-配置"><a href="#1-4-修改-solr-配置" class="headerlink" title="1.4 修改 solr 配置"></a>1.4 修改 solr 配置</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /opt/module/solr/bin/solr.in.sh</span><br><span class="line"></span><br><span class="line"># 修改ZK_HOST</span><br><span class="line">ZK_HOST=&quot;szst-dev-bigdata-05:2181,szst-dev-bigdata-06:2181,szst-dev-bigdata-07:2181&quot;</span><br></pre></td></tr></table></figure>

<h2 id="1-5-启动-solr"><a href="#1-5-启动-solr" class="headerlink" title="1.5 启动 solr"></a>1.5 启动 solr</h2><p>启动前需要保证 ZK 已正常运行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 三个节点各自执行</span><br><span class="line">sudo -i -u solr /opt/module/solr/bin/solr start</span><br></pre></td></tr></table></figure>

<h2 id="1-6-访问-web-页面"><a href="#1-6-访问-web-页面" class="headerlink" title="1.6 访问 web 页面"></a>1.6 访问 web 页面</h2><p>默认端口为 8983，可指定三台节点中的任意一台 IP，<a target="_blank" rel="noopener" href="http://szst-dev-bigdata-05:8983/">http://szst-dev-bigdata-05:8983</a></p>
<h1 id="2-Atlas-安装"><a href="#2-Atlas-安装" class="headerlink" title="2 Atlas 安装"></a>2 Atlas 安装</h1><h2 id="2-1-解压-apache-atlas-2-1-0-server-tar-gz-到-opt-module-目录下面"><a href="#2-1-解压-apache-atlas-2-1-0-server-tar-gz-到-opt-module-目录下面" class="headerlink" title="2.1 解压 apache-atlas-2.1.0-server.tar.gz 到/opt/module/目录下面"></a>2.1 解压 apache-atlas-2.1.0-server.tar.gz 到/opt/module/目录下面</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf apache-atlas-2.1.0-server.tar.gz -C /opt/module/</span><br><span class="line">cd /opt/module/</span><br><span class="line">mv apache-atlas-2.1.0 atlas</span><br></pre></td></tr></table></figure>

<h2 id="2-2-Atlas-配置"><a href="#2-2-Atlas-配置" class="headerlink" title="2.2 Atlas 配置"></a>2.2 <strong>Atlas 配置</strong></h2><p>配置完以下内容后，根据实际需要集成对应的组件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># atlas集成hbase</span><br><span class="line">atlas.graph.storage.hostname=szst-dev-bigdata-05:2181,szst-dev-bigdata-06:2181,szst-dev-bigdata-07:2181</span><br><span class="line">export HBASE_CONF_DIR=/opt/datasophon/hbase-2.0.2/conf</span><br><span class="line"></span><br><span class="line"># atlas集成solr</span><br><span class="line">atlas.graph.index.search.backend=solr</span><br><span class="line">atlas.graph.index.search.solr.mode=cloud</span><br><span class="line">atlas.graph.index.search.solr.zookeeper-url=szst-dev-bigdata-05:2181,szst-dev-bigdata-06:2181,szst-dev-bigdata-07:2181</span><br><span class="line"></span><br><span class="line"># atlas集成kafka</span><br><span class="line">atlas.notification.embedded=false</span><br><span class="line">atlas.kafka.data=/data/kafka-logs</span><br><span class="line">atlas.kafka.zookeeper.connect=szst-dev-bigdata-05:2181,szst-dev-bigdata-06:2181,szst-dev-bigdata-07:2181</span><br><span class="line">atlas.kafka.bootstrap.servers=szst-dev-bigdata-05:9092,szst-dev-bigdata-06:9092,szst-dev-bigdata-07:9092</span><br><span class="line"></span><br><span class="line"># atlas server配置</span><br><span class="line">######### Server Properties #########</span><br><span class="line">atlas.rest.address=http://szst-dev-bigdata-05:21000</span><br><span class="line"># If enabled and set to true, this will run setup steps when the server starts</span><br><span class="line">atlas.server.run.setup.on.start=false</span><br><span class="line">######### Entity Audit Configs #########</span><br><span class="line">atlas.audit.hbase.tablename=apache_atlas_entity_audit</span><br><span class="line">atlas.audit.zookeeper.session.timeout.ms=1000</span><br><span class="line">atlas.audit.hbase.zookeeper.quorum=szst-dev-bigdata-05:2181,szst-dev-bigdata-06:2181,szst-dev-bigdata-07:2181</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo -i -u solr /opt/module/solr/bin/solr create -c vertex_index -d /opt/module/atlas/conf/solr -shards 3 -replicationFactor 2</span><br><span class="line">sudo -i -u solr /opt/module/solr/bin/solr create -c edge_index -d /opt/module/atlas/conf/solr -shards 3 -replicationFactor 2</span><br><span class="line">sudo -i -u solr /opt/module/solr/bin/solr create -c fulltext_index -d /opt/module/atlas/conf/solr -shards 3 -replicationFactor 2</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export HBASE_CONF_DIR=/opt/datasophon/hbase-2.0.2/conf</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#去掉如下代码的注释</span><br><span class="line">&lt;appender name=&quot;perf_appender&quot; class=&quot;org.apache.log4j.DailyRollingFileAppender&quot;&gt;</span><br><span class="line">   &lt;param name=&quot;file&quot; value=&quot;$&#123;atlas.log.dir&#125;/atlas_perf.log&quot; /&gt;</span><br><span class="line">   &lt;param name=&quot;datePattern&quot; value=&quot;&#x27;.&#x27;yyyy-MM-dd&quot; /&gt;</span><br><span class="line">   &lt;param name=&quot;append&quot; value=&quot;true&quot; /&gt;</span><br><span class="line">   &lt;layout class=&quot;org.apache.log4j.PatternLayout&quot;&gt;</span><br><span class="line">   		&lt;param name=&quot;ConversionPattern&quot; value=&quot;%d|%t|%m%n&quot; /&gt;</span><br><span class="line">   &lt;/layout&gt;</span><br><span class="line">&lt;/appender&gt;</span><br><span class="line">&lt;logger name=&quot;org.apache.atlas.perf&quot; additivity=&quot;false&quot;&gt;</span><br><span class="line">   &lt;level value=&quot;debug&quot; /&gt;</span><br><span class="line">   &lt;appender-ref ref=&quot;perf_appender&quot; /&gt;</span><br><span class="line">&lt;/logger&gt;</span><br></pre></td></tr></table></figure>

<h2 id="2-3-Atlas-集成组件（以-Hive-为例）"><a href="#2-3-Atlas-集成组件（以-Hive-为例）" class="headerlink" title="2.3 Atlas 集成组件（以 Hive 为例）"></a>2.3 Atlas 集成组件（以 Hive 为例）</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">######### Hive Hook Configs #######</span><br><span class="line">atlas.hook.hive.synchronous=false</span><br><span class="line">atlas.hook.hive.numRetries=3</span><br><span class="line">atlas.hook.hive.queueSize=10000</span><br><span class="line">atlas.cluster.name=primary</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 配置 Hive Hook</span><br><span class="line">&lt;property&gt;</span><br><span class="line"> &lt;name&gt;hive.exec.post.hooks&lt;/name&gt;</span><br><span class="line"> &lt;value&gt;org.apache.atlas.hive.hook.HiveHook&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 解压</span><br><span class="line">tar -zxvf apache-atlas-2.1.0-hive-hook.tar.gz</span><br><span class="line"># 将 Hive Hook 依赖复制到 Atlas 安装路径</span><br><span class="line">cp -r apache-atlas-hive-hook-2.1.0/* /opt/module/atlas/</span><br><span class="line"></span><br><span class="line">cd /opt/module/hive/conf/</span><br><span class="line">mv hive-env.sh.template hive-env.sh</span><br><span class="line">vi hive-env.sh</span><br><span class="line">增加以下配置 export HIVE_AUX_JARS_PATH=/opt/module/atlas/hook/hive</span><br><span class="line"></span><br><span class="line"># 将 Atlas 配置文件/opt/module/atlas/conf/atlas-application.properties拷贝到/opt/module/hive/conf 目录</span><br><span class="line">cp /opt/module/atlas/conf/atlas-application.properties /opt/module/hive/conf/</span><br></pre></td></tr></table></figure>

<h2 id="2-4-启动-atlas"><a href="#2-4-启动-atlas" class="headerlink" title="2.4 启动 atlas"></a>2.4 启动 atlas</h2><p>依赖环境： hadoop 集群，zookeeper 集群，kafka 集群，hbase 集群，solr 集群</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/opt/module/atlas/bin/atlas_start.py</span><br></pre></td></tr></table></figure>

<h2 id="2-5-访问-web-页面"><a href="#2-5-访问-web-页面" class="headerlink" title="2.5 访问 web 页面"></a>2.5 访问 web 页面</h2><p>url:<br><a target="_blank" rel="noopener" href="http://szst-dev-bigdata-05:21000/">http://szst-dev-bigdata-05:21000</a><br>账号/密码：<br>admin/admin</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/30/yuque/JDBC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/30/yuque/JDBC/" class="post-title-link" itemprop="url">JDBC</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-30 16:54:49" itemprop="dateCreated datePublished" datetime="2022-11-30T16:54:49+08:00">2022-11-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-02-07 21:27:17" itemprop="dateModified" datetime="2023-02-07T21:27:17+08:00">2023-02-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="https://cdn.jsdelivr.net/gh/heheii/blog-imag/blog-images/FthfZ5Fl_s7b6BX_nQVV-SJgQJ_5.png"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/28/yuque/%E6%97%A0%E6%A0%87%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/28/yuque/%E6%97%A0%E6%A0%87%E9%A2%98/" class="post-title-link" itemprop="url">无标题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-10-28 10:02:01" itemprop="dateCreated datePublished" datetime="2022-10-28T10:02:01+08:00">2022-10-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-02-07 21:27:18" itemprop="dateModified" datetime="2023-02-07T21:27:18+08:00">2023-02-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="分布式事务"><a href="#分布式事务" class="headerlink" title="分布式事务"></a>分布式事务</h1><h1 id="1-什么是分布式事务"><a href="#1-什么是分布式事务" class="headerlink" title="1.什么是分布式事务"></a>1.什么是分布式事务</h1><p>要了解分布式事务，必须先了解本地事务。</p>
<h2 id="1-1-本地事务"><a href="#1-1-本地事务" class="headerlink" title="1.1.本地事务"></a>1.1.本地事务</h2><p>本地事务，是指传统的单机数据库事务，必须具备 ACID 原则：</p>
<ul>
<li><strong>原子性（A）</strong></li>
</ul>
<p>所谓的原子性就是说，在整个事务中的所有操作，要么全部完成，要么全部不做，没有中间状态。对于事务在执行中发生错误，所有的操作都会被回滚，整个事务就像从没被执行过一样。</p>
<ul>
<li><strong>一致性（C）</strong></li>
</ul>
<p>事务的执行必须保证系统的一致性，在事务开始之前和事务结束以后，数据库的完整性没有被破坏，就拿转账为例，A 有 500 元，B 有 500 元，如果在一个事务里 A 成功转给 B50 元，那么不管发生什么，那么最后 A 账户和 B 账户的数据之和必须是 1000 元。</p>
<ul>
<li><strong>隔离性（I）</strong></li>
</ul>
<p>所谓的隔离性就是说，事务与事务之间不会互相影响，一个事务的中间状态不会被其他事务感知。数据库保证隔离性包括四种不同的隔离级别：</p>
<pre><code>Read Uncommitted（读取未提交内容）

Read Committed（读取提交内容）

Repeatable Read（可重读）

Serializable（可串行化）
</code></pre>
<ul>
<li><strong>持久性（D）</strong></li>
</ul>
<p>所谓的持久性，就是说一旦事务提交了，那么事务对数据所做的变更就完全保存在了数据库中，即使发生停电，系统宕机也是如此。</p>
<p>因为在传统项目中，项目部署基本是单点式：即单个服务器和单个数据库。这种情况下，数据库本身的事务机制就能保证 ACID 的原则，这样的事务就是本地事务。</p>
<p>概括来讲，单个服务与单个数据库的架构中，产生的事务都是本地事务。</p>
<p>其中原子性和持久性就要靠 undo 和 redo 日志来实现。</p>
<h2 id="1-2-undo-和-redo"><a href="#1-2-undo-和-redo" class="headerlink" title="1.2.undo 和 redo"></a>1.2.undo 和 redo</h2><p>本小节参考内容：<a target="_blank" rel="noopener" href="http://www.zhdba.com/mysqlops/2012/04/06/innodb-log1/">mysqlops</a></p>
<p>在数据库系统中，既有存放数据的文件，也有存放日志的文件。日志在内存中也是有缓存 Log buffer，也有磁盘文件 log file。</p>
<p>MySQL 中的日志文件，有这么两种与事务有关：undo 日志与 redo 日志。</p>
<h3 id="1-2-1-undo-日志"><a href="#1-2-1-undo-日志" class="headerlink" title="1.2.1.undo 日志"></a>1.2.1.undo 日志</h3><p>数据库事务具备原子性（<strong>Atomicity</strong>），如果事务执行失败，需要把数据回滚。</p>
<p>事务同时还具备持久性**(Durability)**，事务对数据所做的变更就完全保存在了数据库，不能因为故障而丢失。</p>
<p>原子性可以利用 undo 日志来实现。</p>
<p>Undo Log 的原理很简单，为了满足事务的原子性，在操作任何数据之前，首先将数据备份到 Undo Log。然后进行数据的修改。如果出现了错误或者用户执行了 ROLLBACK 语句，系统可以利用 Undo Log 中的备份将数据恢复到事务开始之前的状态。</p>
<p>数据库写入数据到磁盘之前，会把<strong>数据先缓存在内存</strong>中，事务提交时才会写入磁盘中。</p>
<p>用 Undo Log 实现原子性和持久化的事务的简化过程：</p>
<p>假设有 A、B 两个数据，值分别为 1,2。<br>A. 事务开始.<br>B. 记录 A=1 到 undo log.<br>C. 修改 A=3.<br>D. 记录 B=2 到 undo log.<br>E. 修改 B=4.<br>F. 将 undo log 写到磁盘。<br>G. 将数据写到磁盘。<br>H. 事务提交</p>
<ul>
<li>如何保证持久性？<br>事务提交前，会把修改数据到磁盘前，也就是说只要事务提交了，数据肯定持久化了。</li>
<li>如何保证原子性？<ul>
<li>每次对数据库修改，都会把修改前数据记录在 undo log，那么需要回滚时，可以读取 undo log，恢复数据。</li>
<li>若系统在 G 和 H 之间崩溃<br>此时事务并未提交，需要回滚。而 undo log 已经被持久化，可以根据 undo log 来恢复数据</li>
<li>若系统在 G 之前崩溃<br>此时数据并未持久化到硬盘，依然保持在事务之前的状态</li>
</ul>
</li>
</ul>
<p><strong>缺陷：</strong>每个事务提交前将数据和 Undo Log 写入磁盘，这样会导致大量的磁盘 IO，因此性能很低。</p>
<p>如果能够将数据缓存一段时间，就能减少 IO 提高性能。但是这样就会丧失事务的持久性。因此引入了另外一种机制来实现持久化，即<strong>Redo Log</strong>.</p>
<h3 id="1-2-2-redo-日志"><a href="#1-2-2-redo-日志" class="headerlink" title="1.2.2.redo 日志"></a>1.2.2.redo 日志</h3><p>和 Undo Log 相反，Redo Log 记录的是<strong>新数据</strong>的备份。在事务提交前，只要将 Redo Log 持久化即可，不需要将数据持久化，减少了 IO 的次数。</p>
<p>先来看下基本原理：</p>
<blockquote>
<p><strong>Undo + Redo 事务的简化过程</strong></p>
</blockquote>
<p>假设有 A、B 两个数据，值分别为 1,2</p>
<p>A. 事务开始.<br>B. 记录 A=1 到 undo log buffer.<br>C. 修改 A=3.<br>D. 记录 A=3 到 redo log buffer.<br>E. 记录 B=2 到 undo log buffer.<br>F. 修改 B=4.<br>G. 记录 B=4 到 redo log buffer.<br>H. 将 undo log 写入磁盘<br>I. 将 redo log 写入磁盘<br>J. 事务提交</p>
<blockquote>
<p>安全和性能问题</p>
</blockquote>
<ul>
<li>如何保证原子性？<br>如果在事务提交前故障，通过 undo log 日志恢复数据。如果 undo log 都还没写入，那么数据就尚未持久化，无需回滚</li>
<li>如何保证持久化？<br>大家会发现，这里并没有出现数据的持久化。因为数据已经写入 redo log，而 redo log 持久化到了硬盘，因此只要到了步骤<code>I</code>以后，事务是可以提交的。</li>
<li>内存中的数据库数据何时持久化到磁盘？<br>因为 redo log 已经持久化，因此数据库数据写入磁盘与否影响不大，不过为了避免出现脏数据（内存中与磁盘不一致），事务提交后也会将内存数据刷入磁盘（也可以按照固设定的频率刷新内存数据到磁盘中）。</li>
<li>redo log 何时写入磁盘<br>redo log 会在事务提交之前，或者 redo log buffer 满了的时候写入磁盘</li>
</ul>
<p>这里存在两个问题：</p>
<p>问题 1：之前是写 undo 和数据库数据到硬盘，现在是写 undo 和 redo 到磁盘，似乎没有减少 IO 次数</p>
<ul>
<li>数据库数据写入是随机 IO，性能很差</li>
<li>redo log 在初始化时会开辟一段连续的空间，写入是顺序 IO，性能很好</li>
<li>实际上 undo log 并不是直接写入磁盘，而是先写入到 redo log buffer 中，当 redo log 持久化时，undo log 就同时持久化到硬盘了。</li>
</ul>
<p>因此事务提交前，只需要对 redo log 持久化即可。</p>
<p>另外，redo log 并不是写入一次就持久化一次，redo log 在内存中也有自己的缓冲池：<code>redo log buffer</code>。每次写 redo log 都是写入到 buffer，在提交时一次性持久化到磁盘，减少 IO 次数。</p>
<p>问题 2：redo log 数据是写入内存 buffer 中，当 buffer 满或者事务提交时，将 buffer 数据写入磁盘。</p>
<p>redo log 中记录的数据，有可能包含尚未提交事务，如果此时数据库崩溃，那么如何完成数据恢复？</p>
<p>数据恢复有两种策略：</p>
<ul>
<li>恢复时，只重做已经提交了的事务</li>
<li>恢复时，重做所有事务包括未提交的事务和回滚了的事务。然后通过 Undo Log 回滚那些未提交的事务</li>
</ul>
<p>Inodb 引擎采用的是第二种方案，因此 undo log 要在 redo log 前持久化</p>
<h3 id="1-2-3-总结"><a href="#1-2-3-总结" class="headerlink" title="1.2.3.总结"></a>1.2.3.总结</h3><p>最后总结一下：</p>
<ul>
<li>undo log 记录更新前数据，用于保证事务原子性</li>
<li>redo log 记录更新后数据，用于保证事务的持久性</li>
<li>redo log 有自己的内存 buffer，先写入到 buffer，事务提交时写入磁盘</li>
<li>redo log 持久化之后，意味着事务是<strong>可提交</strong>的</li>
</ul>
<h2 id="1-3-分布式事务"><a href="#1-3-分布式事务" class="headerlink" title="1.3.分布式事务"></a>1.3.分布式事务</h2><p>分布式事务，就是指不是在单个服务或单个数据库架构下，产生的事务：</p>
<ul>
<li>跨数据源的分布式事务</li>
<li>跨服务的分布式事务</li>
<li>综合情况</li>
</ul>
<h3 id="1）跨数据源"><a href="#1）跨数据源" class="headerlink" title="1）跨数据源"></a>1）跨数据源</h3><p>随着业务数据规模的快速发展，数据量越来越大，单库单表逐渐成为瓶颈。所以我们对数据库进行了水平拆分，将原单库单表拆分成数据库分片，于是就产生了跨数据库事务问题。</p>
<h3 id=""><a href="#" class="headerlink" title=""></a><img src="assets/image-20200304201018438.png"></h3><h3 id="2）跨服务"><a href="#2）跨服务" class="headerlink" title="2）跨服务"></a>2）跨服务</h3><p>在业务发展初期，“一块大饼”的单业务系统架构，能满足基本的业务需求。但是随着业务的快速发展，系统的访问量和业务复杂程度都在快速增长，单系统架构逐渐成为业务发展瓶颈，解决业务系统的高耦合、可伸缩问题的需求越来越强烈。</p>
<p>如下图所示，按照面向服务（SOA）的架构的设计原则，将单业务系统拆分成多个业务系统，降低了各系统之间的耦合度，使不同的业务系统专注于自身业务，更有利于业务的发展和系统容量的伸缩。</p>
<p><img src="assets/image-20200304202639509.png"></p>
<h3 id="3）分布式系统的数据一致性问题"><a href="#3）分布式系统的数据一致性问题" class="headerlink" title="3）分布式系统的数据一致性问题"></a>3）分布式系统的数据一致性问题</h3><p>在数据库水平拆分、服务垂直拆分之后，一个业务操作通常要跨多个数据库、服务才能完成。在分布式网络环境下，我们无法保障所有服务、数据库都百分百可用，一定会出现部分服务、数据库执行成功，另一部分执行失败的问题。</p>
<p>当出现部分业务操作成功、部分业务操作失败时，业务数据就会出现不一致。</p>
<p>例如电商行业中比较常见的下单付款案例，包括下面几个行为：</p>
<ul>
<li>创建新订单</li>
<li>扣减商品库存</li>
<li>从用户账户余额扣除金额</li>
</ul>
<p>完成上面的操作需要访问三个不同的微服务和三个不同的数据库。</p>
<p><img src="assets/image-20200304204442839.png"></p>
<p>在分布式环境下，肯定会出现部分操作成功、部分操作失败的问题，比如：订单生成了，库存也扣减了，但是 用户账户的余额不足，这就造成数据不一致。</p>
<p>订单的创建、库存的扣减、账户扣款在每一个服务和数据库内是一个本地事务，可以保证 ACID 原则。</p>
<p>但是当我们把三件事情看做一个事情事，要满足保证“业务”的原子性，要么所有操作全部成功，要么全部失败，不允许出现部分成功部分失败的现象，这就是分布式系统下的事务了。</p>
<p>此时 ACID 难以满足，这是分布式事务要解决的问题</p>
<h1 id="2-解决分布式事务的思路"><a href="#2-解决分布式事务的思路" class="headerlink" title="2.解决分布式事务的思路"></a>2.解决分布式事务的思路</h1><p>为什么分布式系统下，事务的 ACID 原则难以满足？</p>
<p>这得从 CAP 定理和 BASE 理论说起。</p>
<h2 id="2-1-CAP-定理"><a href="#2-1-CAP-定理" class="headerlink" title="2.1.CAP 定理"></a>2.1.CAP 定理</h2><p>本小节内容摘自：<a target="_blank" rel="noopener" href="https://www.ruanyifeng.com/blog/2018/07/cap.html">CAP 定理的含义</a></p>
<p>什么是 CAP 定理呢？</p>
<p><img src="assets/image-20200304205842784.png"></p>
<p>1998 年，加州大学的计算机科学家 Eric Brewer 提出，分布式系统有三个指标。</p>
<blockquote>
<ul>
<li>Consistency（一致性）</li>
<li>Availability（可用性）</li>
<li>Partition tolerance （分区容错性）</li>
</ul>
</blockquote>
<p>它们的第一个字母分别是 C、A、P。</p>
<p>Eric Brewer 说，这三个指标不可能同时做到。这个结论就叫做 CAP 定理。</p>
<h3 id="2-1-1-Partition-tolerance"><a href="#2-1-1-Partition-tolerance" class="headerlink" title="2.1.1.Partition tolerance"></a>2.1.1.Partition tolerance</h3><p>先看 Partition tolerance，中文叫做”分区容错”。</p>
<p>大多数分布式系统都分布在多个子网络。每个子网络就叫做一个区（partition）。分区容错的意思是，区间通信可能失败。比如，一台服务器放在上海，另一台服务器放在北京，这就是两个区，它们之间可能因网络问题无法通信。</p>
<p>如图：</p>
<p><img src="assets/image-20200304210120471.png"></p>
<p>上图中，G1 和 G2 是两台跨区的服务器。G1 向 G2 发送一条消息，G2 可能无法收到。系统设计的时候，必须考虑到这种情况。</p>
<p>一般来说，分布式系统，分区容错无法避免，因此可以认为 CAP 的 P 总是成立。根据 CAP 定理，剩下的 C 和 A 无法同时做到。</p>
<h3 id="2-1-2-Consistency"><a href="#2-1-2-Consistency" class="headerlink" title="2.1.2.Consistency"></a>2.1.2.Consistency</h3><p>Consistency 中文叫做”一致性”。意思是，写操作之后的读操作，必须返回该值。举例来说，某条记录是 v0，用户向 G1 发起一个写操作，将其改为 v1。</p>
<p><img src="assets/image-20200304210414309.png"></p>
<p>接下来，用户的读操作就会得到 v1。这就叫一致性。</p>
<p><img src="assets/image-20200304210506575.png"></p>
<p>问题是，用户有可能向 G2 发起读操作，由于 G2 的值没有发生变化，因此返回的是 v0。G1 和 G2 读操作的结果不一致，这就不满足一致性了。</p>
<p><img src="assets/image-20200304210521364.png"></p>
<p>为了让 G2 也能变为 v1，就要在 G1 写操作的时候，让 G1 向 G2 发送一条消息，要求 G2 也改成 v1。</p>
<p><img src="assets/image-20200304210540168.png"></p>
<p>这样的话，用户向 G2 发起读操作，也能得到 v1。</p>
<p><img src="assets/image-20200304210557117.png"></p>
<h3 id="2-1-3-Availability"><a href="#2-1-3-Availability" class="headerlink" title="2.1.3.Availability"></a>2.1.3.Availability</h3><p>Availability 中文叫做”可用性”，意思是只要收到用户的请求，服务器就必须给出回应（对和错不论）。</p>
<p>用户可以选择向 G1 或 G2 发起读操作。不管是哪台服务器，只要收到请求，就必须告诉用户，到底是 v0 还是 v1，否则就不满足可用性。</p>
<h3 id="2-1-4-Consistency-和-Availability-的矛盾"><a href="#2-1-4-Consistency-和-Availability-的矛盾" class="headerlink" title="2.1.4.Consistency 和 Availability 的矛盾"></a>2.1.4.Consistency 和 Availability 的矛盾</h3><p>一致性和可用性，为什么不可能同时成立？</p>
<p>答案很简单，因为可能通信失败（即出现分区容错）。</p>
<p>如果保证 G2 的一致性，那么 G1 必须在写操作时，锁定 G2 的读操作和写操作。只有数据同步后，才能重新开放读写。锁定期间，G2 不能读写，没有可用性不。</p>
<p>如果保证 G2 的可用性，那么势必不能锁定 G2，所以一致性不成立。</p>
<p>综上所述，G2 无法同时做到一致性和可用性。系统设计时只能选择一个目标。如果追求一致性，那么无法保证所有节点的可用性；如果追求所有节点的可用性，那就没法做到一致性。</p>
<h3 id="2-1-5-几点疑问"><a href="#2-1-5-几点疑问" class="headerlink" title="2.1.5.几点疑问"></a>2.1.5.几点疑问</h3><ul>
<li>怎样才能同时满足 CA？<br>除非是单点架构</li>
<li>何时要满足 CP？<br>对一致性要求高的场景。例如我们的 Zookeeper 就是这样的，在服务节点间数据同步时，服务对外不可用。</li>
<li>何时满足 AP？<br>对可用性要求较高的场景。例如 Eureka，必须保证注册中心随时可用，不然拉取不到服务就可能出问题。</li>
</ul>
<h2 id="2-2-Base-理论"><a href="#2-2-Base-理论" class="headerlink" title="2.2.Base 理论"></a>2.2.Base 理论</h2><p>BASE 是三个单词的缩写：</p>
<ul>
<li>Basically Available（基本可用）</li>
<li>Soft state（软状态）</li>
<li>Eventually consistent（最终一致性）</li>
</ul>
<p>而我们解决分布式事务，就是根据上述理论来实现。</p>
<p>还以上面的下单减库存和扣款为例：</p>
<p>订单服务、库存服务、用户服务及他们对应的数据库就是分布式应用中的三个部分。</p>
<ul>
<li>CP 方式：现在如果要满足事务的强一致性，就必须在订单服务数据库锁定的同时，对库存服务、用户服务数据资源同时锁定。等待三个服务业务全部处理完成，才可以释放资源。此时如果有其他请求想要操作被锁定的资源就会被阻塞，这样就是满足了 CP。<br>这就是强一致，弱可用</li>
<li>AP 方式：三个服务的对应数据库各自独立执行自己的业务，执行本地事务，不要求互相锁定资源。但是这个中间状态下，我们去访问数据库，可能遇到数据不一致的情况，不过我们需要做一些后补措施，保证在经过一段时间后，数据最终满足一致性。<br>这就是高可用，但弱一致（最终一致）。</li>
</ul>
<p>由上面的两种思想，延伸出了很多的分布式事务解决方案：</p>
<ul>
<li>XA</li>
<li>TCC</li>
<li>可靠消息最终一致</li>
<li>AT</li>
</ul>
<h2 id="2-4-分阶段提交"><a href="#2-4-分阶段提交" class="headerlink" title="2.4.分阶段提交"></a>2.4.分阶段提交</h2><h3 id="2-4-1DTP-和-XA"><a href="#2-4-1DTP-和-XA" class="headerlink" title="2.4.1DTP 和 XA"></a>2.4.1DTP 和 XA</h3><p>分布式事务的解决手段之一，就是两阶段提交协议（2PC：Two-Phase Commit）</p>
<p>那么到底什么是两阶段提交协议呢？</p>
<p>1994 年，X/Open 组织（即现在的 Open Group ）定义了分布式事务处理的 DTP 模型。该模型包括这样几个角色：</p>
<ul>
<li>应用程序（ AP ）：我们的微服务</li>
<li>事务管理器（ TM ）：全局事务管理者</li>
<li>资源管理器（ RM ）：一般是数据库</li>
<li>通信资源管理器（ CRM ）：是 TM 和 RM 间的通信中间件</li>
</ul>
<p>在该模型中，一个分布式事务（全局事务）可以被拆分成许多个本地事务，运行在不同的 AP 和 RM 上。每个本地事务的 ACID 很好实现，但是全局事务必须保证其中包含的每一个本地事务都能同时成功，若有一个本地事务失败，则所有其它事务都必须回滚。但问题是，本地事务处理过程中，并不知道其它事务的运行状态。因此，就需要通过 CRM 来通知各个本地事务，同步事务执行的状态。</p>
<p>因此，各个本地事务的通信必须有统一的标准，否则不同数据库间就无法通信。<strong>XA</strong>就是 X/Open DTP 中通信中间件与 TM 间联系的<strong>接口规范</strong>，定义了用于通知事务开始、提交、终止、回滚等接口，各个数据库厂商都必须实现这些接口。</p>
<h3 id="2-4-2-二阶段提交"><a href="#2-4-2-二阶段提交" class="headerlink" title="2.4.2.二阶段提交"></a>2.4.2.二阶段提交</h3><p>参考：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/35298019">漫话分布式系统共识协议: 2PC/3PC 篇</a></p>
<p><strong>二阶提交协议</strong>就是根据这一思想衍生出来的，将全局事务拆分为两个阶段来执行：</p>
<ul>
<li>阶段一：准备阶段，各个本地事务完成本地事务的准备工作。</li>
<li>阶段二：执行阶段，各个本地事务根据上一阶段执行结果，进行提交或回滚。</li>
</ul>
<p>这个过程中需要一个协调者（coordinator），还有事务的参与者（voter）。</p>
<blockquote>
<p>1）正常情况</p>
</blockquote>
<p><img src="assets/image-20200305141029973.png"></p>
<p><strong>投票阶段</strong>：协调组询问各个事务参与者，是否可以执行事务。每个事务参与者执行事务，写入 redo 和 undo 日志，然后反馈事务执行成功的信息（<code>agree</code>）</p>
<p><strong>提交阶段</strong>：协调组发现每个参与者都可以执行事务（<code>agree</code>），于是向各个事务参与者发出<code>commit</code>指令，各个事务参与者提交事务。</p>
<blockquote>
<p>2）异常情况</p>
</blockquote>
<p>当然，也有异常的时候：</p>
<p><img src="assets/image-20200305141318326.png"></p>
<p><strong>投票阶段</strong>：协调组询问各个事务参与者，是否可以执行事务。每个事务参与者执行事务，写入 redo 和 undo 日志，然后反馈事务执行结果，但只要有一个参与者返回的是<code>Disagree</code>，则说明执行失败。</p>
<p><strong>提交阶段</strong>：协调组发现有一个或多个参与者返回的是<code>Disagree</code>，认为执行失败。于是向各个事务参与者发出<code>abort</code>指令，各个事务参与者回滚事务。</p>
<blockquote>
<p>3）缺陷</p>
</blockquote>
<p>二阶段提交的问题：</p>
<ul>
<li>单点故障问题<br>2PC 的缺点在于不能处理 fail-stop 形式的节点 failure. 比如下图这种情况.</li>
</ul>
<p>假设 coordinator 和 voter3 都在 Commit 这个阶段 crash 了, 而 voter1 和 voter2 没有收到 commit 消息. 这时候 voter1 和 voter2 就陷入了一个困境. 因为他们并不能判断现在是两个场景中的哪一种:<br><img src="assets/image-20200305142812815.png"></p>
<ul>
<li>阻塞问题<br>在准备阶段、提交阶段，每个事物参与者都会锁定本地资源，并等待其它事务的执行结果，阻塞时间较长，资源锁定时间太久，因此执行的效率就比较低了。</li>
</ul>
<p>面对二阶段提交的上述缺点，后来又演变出了三阶段提交，但是依然没有完全解决阻塞和资源锁定的问题，而且引入了一些新的问题，因此实际使用的场景较少。</p>
<h3 id="2-4-3-使用场景"><a href="#2-4-3-使用场景" class="headerlink" title="2.4.3.使用场景"></a>2.4.3.使用场景</h3><p>对事务有强一致性要求，对事务执行效率不敏感，并且不希望有太多代码侵入。</p>
<h2 id="2-5-TCC"><a href="#2-5-TCC" class="headerlink" title="2.5.TCC"></a>2.5.TCC</h2><p>TCC 模式可以解决 2PC 中的资源锁定和阻塞问题，减少资源锁定时间。</p>
<h3 id="2-5-1-基本原理"><a href="#2-5-1-基本原理" class="headerlink" title="2.5.1.基本原理"></a>2.5.1.基本原理</h3><p>它本质是一种补偿的思路。事务运行过程包括三个方法，</p>
<ul>
<li>Try：资源的检测和预留；</li>
<li>Confirm：执行的业务操作提交；要求 Try 成功 Confirm 一定要能成功；</li>
<li>Cancel：预留资源释放。</li>
</ul>
<p>执行分两个阶段：</p>
<ul>
<li>准备阶段（try）：资源的检测和预留；</li>
<li>执行阶段（confirm/cancel）：根据上一步结果，判断下面的执行方法。如果上一步中所有事务参与者都成功，则这里执行 confirm。反之，执行 cancel</li>
</ul>
<p><img src="assets/image-20200305155521612.png"></p>
<p>粗看似乎与两阶段提交没什么区别，但其实差别很大：</p>
<ul>
<li>try、confirm、cancel 都是独立的事务，不受其它参与者的影响，不会阻塞等待它人</li>
<li>try、confirm、cancel 由程序员在业务层编写，锁粒度有代码控制</li>
</ul>
<h3 id="2-5-2-实例"><a href="#2-5-2-实例" class="headerlink" title="2.5.2.实例"></a>2.5.2.实例</h3><p>我们以之前的下单业务中的扣减余额为例来看下三个不同的方法要怎么编写，假设账户 A 原来余额是 100，需要余额扣减 30 元。如图：</p>
<p><img src="assets/image-20200305155830732.png"></p>
<ul>
<li>一阶段（Try）：余额检查，并冻结用户部分金额，此阶段执行完毕，事务已经提交<ul>
<li>检查用户余额是否充足，如果充足，冻结部分余额</li>
<li>在账户表中添加冻结金额字段，值为 30，余额不变</li>
</ul>
</li>
<li>二阶段<ul>
<li>提交（Confirm）：真正的扣款，把冻结金额从余额中扣除，冻结金额清空<ul>
<li>修改冻结金额为 0，修改余额为 100-30 = 70 元</li>
</ul>
</li>
<li>补偿（Cancel）：释放之前冻结的金额，并非回滚<ul>
<li>余额不变，修改账户冻结金额为 0</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="2-5-3-优势和缺点"><a href="#2-5-3-优势和缺点" class="headerlink" title="2.5.3.优势和缺点"></a>2.5.3.优势和缺点</h3><ul>
<li>优势<br>TCC 执行的每一个阶段都会提交本地事务并释放锁，并不需要等待其它事务的执行结果。而如果其它事务执行失败，最后不是回滚，而是执行补偿操作。这样就避免了资源的长期锁定和阻塞等待，执行效率比较高，属于性能比较好的分布式事务方式。</li>
<li>缺点<ul>
<li>代码侵入：需要人为编写代码实现 try、confirm、cancel，代码侵入较多</li>
<li>开发成本高：一个业务需要拆分成 3 个步骤，分别编写业务实现，业务编写比较复杂</li>
<li>安全性考虑：cancel 动作如果执行失败，资源就无法释放，需要引入重试机制，而重试可能导致重复执行，还要考虑重试时的幂等问题</li>
</ul>
</li>
</ul>
<h3 id="2-5-4-使用场景"><a href="#2-5-4-使用场景" class="headerlink" title="2.5.4.使用场景"></a>2.5.4.使用场景</h3><ul>
<li>对事务有一定的一致性要求（最终一致）</li>
<li>对性能要求较高</li>
<li>开发人员具备较高的编码能力和幂等处理经验</li>
</ul>
<h2 id="2-6-可靠消息服务"><a href="#2-6-可靠消息服务" class="headerlink" title="2.6.可靠消息服务"></a>2.6.可靠消息服务</h2><p>这种实现方式的思路，其实是源于 ebay，其基本的设计思想是将远程分布式事务拆分成一系列的本地事务。</p>
<h3 id="2-6-1-基本原理"><a href="#2-6-1-基本原理" class="headerlink" title="2.6.1.基本原理"></a>2.6.1.基本原理</h3><p>一般分为事务的发起者 A 和事务的其它参与者 B：</p>
<ul>
<li>事务发起者 A 执行本地事务</li>
<li>事务发起者 A 通过 MQ 将需要执行的事务信息发送给事务参与者 B</li>
<li>事务参与者 B 接收到消息后执行本地事务</li>
</ul>
<p>如图：</p>
<p><img src="assets/image-20200305181454125.png"></p>
<p>这个过程有点像你去学校食堂吃饭：</p>
<ul>
<li>拿着钱去收银处，点一份红烧牛肉面，付钱</li>
<li>收银处给你发一个小票，还有一个号牌，你别把票弄丢！</li>
<li>你凭小票和号牌一定能领到一份红烧牛肉面，不管需要多久</li>
</ul>
<p>几个注意事项：</p>
<ul>
<li>事务发起者 A 必须确保本地事务成功后，消息一定发送成功</li>
<li>MQ 必须保证消息正确投递和持久化保存</li>
<li>事务参与者 B 必须确保消息最终一定能消费，如果失败需要多次重试</li>
<li>事务 B 执行失败，会重试，但不会导致事务 A 回滚</li>
</ul>
<p>那么问题来了，我们如何保证消息发送一定成功？如何保证消费者一定能收到消息？</p>
<h3 id="2-6-2-本地消息表"><a href="#2-6-2-本地消息表" class="headerlink" title="2.6.2.本地消息表"></a>2.6.2.本地消息表</h3><p>为了避免消息发送失败或丢失，我们可以把消息持久化到数据库中。实现时有简化版本和解耦合版本两种方式。</p>
<h4 id="1）简化版本"><a href="#1）简化版本" class="headerlink" title="1）简化版本"></a>1）简化版本</h4><p>原理图：</p>
<p><img src="assets/image-20200305183431211.png"></p>
<ul>
<li>事务发起者：<ul>
<li>开启本地事务</li>
<li>执行事务相关业务</li>
<li>发送消息到 MQ</li>
<li>把消息持久化到数据库，标记为已发送</li>
<li>提交本地事务</li>
</ul>
</li>
<li>事务接收者：<ul>
<li>接收消息</li>
<li>开启本地事务</li>
<li>处理事务相关业务</li>
<li>修改数据库消息状态为已消费</li>
<li>提交本地事务</li>
</ul>
</li>
<li>额外的定时任务<ul>
<li>定时扫描表中超时未消费消息，重新发送</li>
</ul>
</li>
</ul>
<p><strong>优点：</strong></p>
<ul>
<li>与 tcc 相比，实现方式较为简单，开发成本低。</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>数据一致性完全依赖于消息服务，因此消息服务必须是可靠的。</li>
<li>需要处理被动业务方的幂等问题</li>
<li>被动业务失败不会导致主动业务的回滚，而是重试被动的业务</li>
<li><strong>事务业务与消息发送业务耦合</strong>、业务数据与消息表要在一起</li>
</ul>
<h4 id="2）独立消息服务"><a href="#2）独立消息服务" class="headerlink" title="2）独立消息服务"></a>2）独立消息服务</h4><p>为了解决上述问题，我们会引入一个独立的消息服务，来完成对消息的持久化、发送、确认、失败重试等一系列行为，大概的模型如下：</p>
<p><img src="assets/image-20200305200131083.png"></p>
<p>一次消息发送的时序图：</p>
<p><img src="assets/image-20200305205430863.png"></p>
<p>事务发起者 A 的基本执行步骤：</p>
<ul>
<li>开启本地事务</li>
<li>通知消息服务，准备发送消息（消息服务将消息持久化，标记为准备发送）</li>
<li>执行本地业务，<ul>
<li>执行失败则终止，通知消息服务，取消发送（消息服务修改订单状态）</li>
<li>执行成功则继续，通知消息服务，确认发送（消息服务发送消息、修改订单状态）</li>
</ul>
</li>
<li>提交本地事务</li>
</ul>
<p>消息服务本身提供下面的接口：</p>
<ul>
<li>准备发送：把消息持久化到数据库，并标记状态为准备发送</li>
<li>取消发送：把数据库消息状态修改为取消</li>
<li>确认发送：把数据库消息状态修改为确认发送。尝试发送消息，成功后修改状态为已发送</li>
<li>确认消费：消费者已经接收并处理消息，把数据库消息状态修改为已消费</li>
<li>定时任务：定时扫描数据库中状态为确认发送的消息，然后询问对应的事务发起者，事务业务执行是否成功，结果：<ul>
<li>业务执行成功：尝试发送消息，成功后修改状态为已发送</li>
<li>业务执行失败：把数据库消息状态修改为取消</li>
</ul>
</li>
</ul>
<p>事务参与者 B 的基本步骤：</p>
<ul>
<li>接收消息</li>
<li>开启本地事务</li>
<li>执行业务</li>
<li>通知消息服务，消息已经接收和处理</li>
<li>提交事务</li>
</ul>
<p><strong>优点：</strong></p>
<ul>
<li>解除了事务业务与消息相关业务的耦合</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>实现起来比较复杂</li>
</ul>
<h3 id="2-6-3-RocketMQ-事务消息"><a href="#2-6-3-RocketMQ-事务消息" class="headerlink" title="2.6.3.RocketMQ 事务消息"></a>2.6.3.RocketMQ 事务消息</h3><p>RocketMQ 本身自带了事务消息，可以保证消息的可靠性，原理其实就是自带了本地消息表，与我们上面讲的思路类似。</p>
<h3 id="2-6-4-RabbitMQ-的消息确认"><a href="#2-6-4-RabbitMQ-的消息确认" class="headerlink" title="2.6.4.RabbitMQ 的消息确认"></a>2.6.4.RabbitMQ 的消息确认</h3><p>RabbitMQ 确保消息不丢失的思路比较奇特，并没有使用传统的本地表，而是利用了消息的确认机制：</p>
<ul>
<li>生产者确认机制：确保消息从生产者到达 MQ 不会有问题<ul>
<li>消息生产者发送消息到 RabbitMQ 时，可以设置一个异步的监听器，监听来自 MQ 的 ACK</li>
<li>MQ 接收到消息后，会返回一个回执给生产者：<ul>
<li>消息到达交换机后路由失败，会返回失败 ACK</li>
<li>消息路由成功，持久化失败，会返回失败 ACK</li>
<li>消息路由成功，持久化成功，会返回成功 ACK</li>
</ul>
</li>
<li>生产者提前编写好不同回执的处理方式<ul>
<li>失败回执：等待一定时间后重新发送</li>
<li>成功回执：记录日志等行为</li>
</ul>
</li>
</ul>
</li>
<li>消费者确认机制：确保消息能够被消费者正确消费<ul>
<li>消费者需要在监听队列的时候指定手动 ACK 模式</li>
<li>RabbitMQ 把消息投递给消费者后，会等待消费者 ACK，接收到 ACK 后才删除消息，如果没有接收到 ACK 消息会一直保留在服务端，如果消费者断开连接或异常后，消息会投递给其它消费者。</li>
<li>消费者处理完消息，提交事务后，手动 ACK。如果执行过程中抛出异常，则不会 ACK，业务处理失败，等待下一条消息</li>
</ul>
</li>
</ul>
<p>经过上面的两种确认机制，可以确保从消息生产者到消费者的消息安全，再结合生产者和消费者两端的本地事务，即可保证一个分布式事务的最终一致性。</p>
<h3 id="2-6-5-消息事务的优缺点"><a href="#2-6-5-消息事务的优缺点" class="headerlink" title="2.6.5.消息事务的优缺点"></a>2.6.5.消息事务的优缺点</h3><p>总结上面的几种模型，消息事务的优缺点如下：</p>
<ul>
<li>优点：<ul>
<li>业务相对简单，不需要编写三个阶段业务</li>
<li>是多个本地事务的结合，因此资源锁定周期短，性能好</li>
</ul>
</li>
<li>缺点：<ul>
<li>代码侵入</li>
<li>依赖于 MQ 的可靠性</li>
<li>消息发起者可以回滚，但是消息参与者无法引起事务回滚</li>
<li>事务时效性差，取决于 MQ 消息发送是否及时，还有消息参与者的执行情况</li>
</ul>
</li>
</ul>
<p>针对事务无法回滚的问题，有人提出说可以再事务参与者执行失败后，再次利用 MQ 通知消息服务，然后由消息服务通知其他参与者回滚。那么，恭喜你，你利用 MQ 和自定义的消息服务再次实现了 2PC 模型，又造了一个大轮子</p>
<h2 id="2-7-AT-模式"><a href="#2-7-AT-模式" class="headerlink" title="2.7.AT 模式"></a>2.7.AT 模式</h2><p>2019 年 1 月份，Seata 开源了 AT 模式。AT 模式是一种无侵入的分布式事务解决方案。可以看做是对 TCC 或者二阶段提交模型的一种优化，解决了 TCC 模式中的代码侵入、编码复杂等问题。</p>
<p>在 AT 模式下，用户只需关注自己的“业务 SQL”，用户的 “业务 SQL” 作为一阶段，Seata 框架会自动生成事务的二阶段提交和回滚操作。</p>
<p>可以参考 Seata 的<a target="_blank" rel="noopener" href="https://seata.io/zh-cn/docs/dev/mode/at-mode.html">官方文档</a>。</p>
<h3 id="2-7-1-基本原理"><a href="#2-7-1-基本原理" class="headerlink" title="2.7.1.基本原理"></a>2.7.1.基本原理</h3><p>先来看一张流程图：</p>
<p><img src="assets/image-20200305212340203.png"></p>
<p>有没有感觉跟 TCC 的执行很像，都是分两个阶段：</p>
<ul>
<li>一阶段：执行本地事务，并返回执行结果</li>
<li>二阶段：根据一阶段的结果，判断二阶段做法：提交或回滚</li>
</ul>
<p>但 AT 模式底层做的事情可完全不同，而且第二阶段根本不需要我们编写，全部有 Seata 自己实现了。也就是说：我们写的<strong>代码与本地事务时代码一样</strong>，无需手动处理分布式事务。</p>
<p>那么，AT 模式如何实现无代码侵入，如何帮我们自动实现二阶段代码的呢？</p>
<blockquote>
<p>一阶段</p>
</blockquote>
<p>在一阶段，Seata 会拦截“业务 SQL”，首先解析 SQL 语义，找到“<code>业务 SQL</code>”要更新的业务数据，在业务数据被更新前，将其保存成“<code>before image</code>”，然后执行“<code>业务 SQL</code>”更新业务数据，在业务数据更新之后，再将其保存成“<code>after image</code>”，最后获取全局行锁，<strong>提交事务</strong>。以上操作全部在一个数据库事务内完成，这样保证了一阶段操作的原子性。</p>
<p>这里的<code>before image</code>和<code>after image</code>类似于数据库的 undo 和 redo 日志，但其实是用数据库模拟的。</p>
<p><img src="assets/image-20200305213652558.png"></p>
<blockquote>
<p>二阶段提交</p>
</blockquote>
<p>二阶段如果是提交的话，因为“<code>业务 SQL</code>”在一阶段已经提交至数据库， 所以 Seata 框架只需将一阶段保存的快照数据和行锁删掉，完成数据清理即可。</p>
<blockquote>
<p>二阶段回滚：</p>
</blockquote>
<p>二阶段如果是回滚的话，Seata 就需要回滚一阶段已经执行的“<code>业务 SQL</code>”，还原业务数据。回滚方式便是用“<code>before image</code>”还原业务数据；但在还原前要首先要校验脏写，对比“数据库当前业务数据”和 “<code>after image</code>”，如果两份数据完全一致就说明没有脏写，可以还原业务数据，如果不一致就说明有<code>脏写</code>，出现脏写就需要转人工处理。</p>
<p><img src="assets/image-20200305214649845.png"></p>
<p>不过因为有全局锁机制，所以可以降低出现<code>脏写</code>的概率。</p>
<p>AT 模式的一阶段、二阶段提交和回滚均由 Seata 框架自动生成，用户只需编写“业务 SQL”，便能轻松接入分布式事务，AT 模式是一种对业务无任何侵入的分布式事务解决方案。</p>
<h3 id="2-7-2-详细架构和流程"><a href="#2-7-2-详细架构和流程" class="headerlink" title="2.7.2.详细架构和流程"></a>2.7.2.详细架构和流程</h3><p>Seata 中的几个基本概念：</p>
<ul>
<li>TC（Transaction Coordinator） - 事务协调者<br>维护全局和分支事务的状态，驱动全局事务提交或回滚（TM 之间的协调者）。</li>
<li>TM（Transaction Manager） - 事务管理器<br>定义全局事务的范围：开始全局事务、提交或回滚全局事务。</li>
<li>RM（Resource Manager） - 资源管理器<br>管理分支事务处理的资源，与 TC 交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。</li>
</ul>
<p>我们看下面的一个架构图</p>
<p><img src="assets/image-20200305225811888.png"></p>
<ul>
<li>TM：业务模块中全局事务的开启者<ul>
<li>向 TC 开启一个全局事务</li>
<li>调用其它微服务</li>
</ul>
</li>
<li>RM：业务模块执行者中，包含 RM 部分，负责向 TC 汇报事务执行状态<ul>
<li>执行本地事务</li>
<li>向 TC 注册分支事务，并提交本地事务执行结果</li>
</ul>
</li>
<li>TM：结束对微服务的调用，通知 TC，全局事务执行完毕，事务一阶段结束</li>
<li>TC：汇总各个分支事务执行结果，决定分布式事务是提交还是回滚；</li>
<li>TC 通知所有 RM 提交/回滚 资源，事务二阶段结束。</li>
</ul>
<p>一阶段：</p>
<ul>
<li>TM 开启全局事务，并向 TC 声明全局事务，包括全局事务 XID 信息</li>
<li>TM 所在服务调用其它微服务</li>
<li>微服务，主要有 RM 来执行<ul>
<li>查询<code>before_image</code></li>
<li>执行本地事务</li>
<li>查询<code>after_image</code></li>
<li>生成<code>undo_log</code>并写入数据库</li>
<li>向 TC 注册分支事务，告知事务执行结果</li>
<li>获取全局锁（阻止其它全局事务并发修改当前数据）</li>
<li>释放本地锁（不影响其它业务对数据的操作）</li>
</ul>
</li>
<li>待所有业务执行完毕，事务发起者（TM）会尝试向 TC 提交全局事务</li>
</ul>
<p>二阶段：</p>
<ul>
<li>TC 统计分支事务执行情况，根据结果判断下一步行为<ul>
<li>分支都成功：通知分支事务，提交事务</li>
<li>有分支执行失败：通知执行成功的分支事务，回滚数据</li>
</ul>
</li>
<li>分支事务的 RM<ul>
<li>提交事务：直接清空<code>before_image</code>和<code>after_image</code>信息，释放全局锁</li>
<li>回滚事务：<ul>
<li>校验 after_image，判断是否有脏写</li>
<li>如果没有脏写，回滚数据到<code>before_image</code>，清除<code>before_image</code>和<code>after_image</code></li>
<li>如果有脏写，请求人工介入</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="2-7-3-工作机制"><a href="#2-7-3-工作机制" class="headerlink" title="2.7.3.工作机制"></a>2.7.3.工作机制</h3><p>详见 Seata 的官方文档：<a target="_blank" rel="noopener" href="https://seata.io/zh-cn/docs/overview/what-is-seata.html">https://seata.io/zh-cn/docs/overview/what-is-seata.html</a></p>
<blockquote>
</blockquote>
<h4 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h4><p>以一个示例来说明整个 AT 分支的工作过程。</p>
<p>业务表：<code>product</code></p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Key</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>bigint(20)</td>
<td>PRI</td>
</tr>
<tr>
<td>name</td>
<td>varchar(100)</td>
<td></td>
</tr>
<tr>
<td>since</td>
<td>varchar(100)</td>
<td></td>
</tr>
</tbody></table>
<p>AT 分支事务的业务逻辑：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> product <span class="keyword">set</span> name <span class="operator">=</span> <span class="string">&#x27;GTS&#x27;</span> <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;TXC&#x27;</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
</blockquote>
<h4 id="一阶段"><a href="#一阶段" class="headerlink" title="一阶段"></a>一阶段</h4><p>过程：</p>
<ol>
<li>解析 SQL：得到 SQL 的类型（UPDATE），表（product），条件（where name = ‘TXC’）等相关的信息。</li>
<li>查询前镜像：根据解析得到的条件信息，生成查询语句，定位数据。</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id, name, since <span class="keyword">from</span> product <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;TXC&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>得到前镜像：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>name</th>
<th>since</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>TXC</td>
<td>2014</td>
</tr>
</tbody></table>
<ol>
<li>执行业务 SQL：更新这条记录的 name 为 ‘GTS’。</li>
<li>查询后镜像：根据前镜像的结果，通过 <strong>主键</strong> 定位数据。</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id, name, since <span class="keyword">from</span> product <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>`;</span><br></pre></td></tr></table></figure>

<p>得到后镜像：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>name</th>
<th>since</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>GTS</td>
<td>2014</td>
</tr>
</tbody></table>
<ol>
<li>插入回滚日志：把前后镜像数据以及业务 SQL 相关的信息组成一条回滚日志记录，插入到 <code>UNDO_LOG</code> 表中。</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;branchId&quot;</span><span class="punctuation">:</span> <span class="number">641789253</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;undoItems&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;afterImage&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;rows&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;id&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;name&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GTS&quot;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;since&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2014&quot;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;tableName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;product&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;beforeImage&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;rows&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;id&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;name&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;TXC&quot;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;since&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2014&quot;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;tableName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;product&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;sqlType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UPDATE&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;xid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xid:xxx&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ol>
<li>提交前，向 TC 注册分支：申请 <code>product</code> 表中，主键值等于 1 的记录的 <strong>全局锁</strong> 。</li>
<li>本地事务提交：业务数据的更新和前面步骤中生成的 UNDO LOG 一并提交。</li>
<li>将本地事务提交的结果上报给 TC。</li>
</ol>
<blockquote>
</blockquote>
<h4 id="二阶段-回滚"><a href="#二阶段-回滚" class="headerlink" title="二阶段-回滚"></a>二阶段-回滚</h4><ol>
<li>收到 TC 的分支回滚请求，开启一个本地事务，执行如下操作。</li>
<li>通过 XID 和 Branch ID 查找到相应的 UNDO LOG 记录。</li>
<li>数据校验：拿 UNDO LOG 中的后镜与当前数据进行比较，如果有不同，说明数据被当前全局事务之外的动作做了修改。这种情况，需要根据配置策略来做处理，详细的说明在另外的文档中介绍。</li>
<li>根据 UNDO LOG 中的前镜像和业务 SQL 的相关信息生成并执行回滚的语句：</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> product <span class="keyword">set</span> name <span class="operator">=</span> <span class="string">&#x27;TXC&#x27;</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<ol>
<li>提交本地事务。并把本地事务的执行结果（即分支事务回滚的结果）上报给 TC。</li>
</ol>
<blockquote>
</blockquote>
<h4 id="二阶段-提交"><a href="#二阶段-提交" class="headerlink" title="二阶段-提交"></a>二阶段-提交</h4><ol>
<li>收到 TC 的分支提交请求，把请求放入一个异步任务的队列中，马上返回提交成功的结果给 TC。</li>
<li>异步任务阶段的分支提交请求将异步和批量地删除相应 UNDO LOG 记录。</li>
</ol>
<h3 id="2-7-4-优缺点"><a href="#2-7-4-优缺点" class="headerlink" title="2.7.4.优缺点"></a>2.7.4.优缺点</h3><p>优点：</p>
<ul>
<li>与 2PC 相比：每个分支事务都是独立提交，不互相等待，减少了资源锁定和阻塞时间</li>
<li>与 TCC 相比：二阶段的执行操作全部自动化生成，无代码侵入，开发成本低</li>
</ul>
<p>缺点：</p>
<ul>
<li>与 TCC 相比，需要动态生成二阶段的反向补偿操作，执行性能略低于 TCC</li>
</ul>
<h2 id="2-8-Saga-模式"><a href="#2-8-Saga-模式" class="headerlink" title="2.8.Saga 模式"></a>2.8.Saga 模式</h2><p>Saga 模式是 Seata 即将开源的长事务解决方案，将由蚂蚁金服主要贡献。</p>
<p>其理论基础是 Hector &amp; Kenneth   在 1987 年发表的论文<a target="_blank" rel="noopener" href="https://microservices.io/patterns/data/saga.html">Sagas</a>。</p>
<p>Seata 官网对于 Saga 的指南：<a target="_blank" rel="noopener" href="https://seata.io/zh-cn/docs/user/saga.html">https://seata.io/zh-cn/docs/user/saga.html</a></p>
<h3 id="基本模型"><a href="#基本模型" class="headerlink" title="基本模型"></a>基本模型</h3><p>在 Saga 模式下，分布式事务内有多个参与者，每一个参与者都是一个冲正补偿服务，需要用户根据业务场景实现其正向操作和逆向回滚操作。</p>
<p>分布式事务执行过程中，依次执行各参与者的正向操作，如果所有正向操作均执行成功，那么分布式事务提交。如果任何一个正向操作执行失败，那么分布式事务会去退回去执行前面各参与者的逆向回滚操作，回滚已提交的参与者，使分布式事务回到初始状态。</p>
<p><img src="assets/1561965208439-606129fe-6761-4177-8887-1fda9306f104.png"></p>
<p>Saga 模式下分布式事务通常是由事件驱动的，各个参与者之间是异步执行的，Saga 模式是一种长事务解决方案。</p>
<h3 id="适用场景："><a href="#适用场景：" class="headerlink" title="适用场景："></a>适用场景：</h3><ul>
<li>业务流程长、业务流程多</li>
<li>参与者包含其它公司或遗留系统服务，无法提供 TCC 模式要求的三个接口</li>
</ul>
<h3 id="优势："><a href="#优势：" class="headerlink" title="优势："></a>优势：</h3><ul>
<li>一阶段提交本地事务，无锁，高性能</li>
<li>事件驱动架构，参与者可异步执行，高吞吐</li>
<li>补偿服务易于实现</li>
</ul>
<h3 id="缺点："><a href="#缺点：" class="headerlink" title="缺点："></a>缺点：</h3><ul>
<li>不保证隔离性（应对方案见<a target="_blank" rel="noopener" href="https://seata.io/zh-cn/docs/user/saga.html">用户文档</a>）</li>
</ul>
<h1 id="3-Seata"><a href="#3-Seata" class="headerlink" title="3.Seata"></a>3.Seata</h1><h2 id="3-1-介绍"><a href="#3-1-介绍" class="headerlink" title="3.1.介绍"></a>3.1.介绍</h2><p>Seata（Simple Extensible Autonomous Transaction Architecture，简单可扩展自治事务框架）是 2019 年 1 月份蚂蚁金服和阿里巴巴共同开源的分布式事务解决方案。Seata 开源半年左右，目前已经有接近一万 star，社区非常活跃。我们热忱欢迎大家参与到 Seata 社区建设中，一同将 Seata 打造成开源分布式事务标杆产品。</p>
<p>Seata：<a target="_blank" rel="noopener" href="https://github.com/seata/seata">https://</a><a target="_blank" rel="noopener" href="https://github.com/seata/seata">github.com/seata/seata</a></p>
<p><img src="assets/1561960344792-8810110b-1eda-4417-944e-7051ca52f90d.png"></p>
<h3 id="3-1-1-Seata-产品模块"><a href="#3-1-1-Seata-产品模块" class="headerlink" title="3.1.1. Seata 产品模块"></a>3.1.1. Seata 产品模块</h3><p>如下图所示，Seata 中有三大模块，分别是 TM、RM 和 TC。 其中 TM 和 RM 是作为 Seata 的客户端与业务系统集成在一起，TC 作为 Seata 的服务端独立部署。</p>
<p><img src="assets/image-20200305225811888.png"></p>
<h3 id="3-1-2-Seata-支持的事务模型"><a href="#3-1-2-Seata-支持的事务模型" class="headerlink" title="3.1.2.Seata 支持的事务模型"></a>3.1.2.Seata 支持的事务模型</h3><p><img src="assets/image-20200305230513415.png"></p>
<h2 id="3-2-AT-模式实战"><a href="#3-2-AT-模式实战" class="headerlink" title="3.2.AT 模式实战"></a>3.2.AT 模式实战</h2><p>Seata 中比较常用的是 AT 模式，这里我们拿 AT 模式来做演示，看看如何在 SpringCloud 微服务中集成 Seata.</p>
<p>我们假定一个用户购买商品的业务逻辑。整个业务逻辑由 3 个微服务提供支持：</p>
<ul>
<li>仓储服务：对给定的商品扣除仓储数量。</li>
<li>订单服务：根据采购需求创建订单。</li>
<li>帐户服务：从用户帐户中扣除余额。</li>
</ul>
<p>流程图：</p>
<p><img src="assets/image-20200306164728739.png"></p>
<p>订单服务在下单时，同时调用库存服务和用户服务，此时就会发生跨服务和跨数据源的分布式事务问题。</p>
<h3 id="3-2-1-准备数据"><a href="#3-2-1-准备数据" class="headerlink" title="3.2.1.准备数据"></a>3.2.1.准备数据</h3><p>执行资料中提供的<code>seata_demo.sql</code>文件，导入数据。</p>
<p>其中包含 4 张表。</p>
<p>Order 表：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `order_tbl` (</span><br><span class="line">  `id` int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `user_id` varchar(255) DEFAULT NULL COMMENT &#x27;用户id&#x27;,</span><br><span class="line">  `commodity_code` varchar(255) DEFAULT NULL COMMENT &#x27;商品码&#x27;,</span><br><span class="line">  `count` int(11) unsigned DEFAULT &#x27;0&#x27; COMMENT &#x27;购买数量&#x27;,</span><br><span class="line">  `money` int(11) unsigned DEFAULT &#x27;0&#x27; COMMENT &#x27;总金额&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`) USING BTREE</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 ROW_FORMAT=COMPACT;</span><br></pre></td></tr></table></figure>

<p>商品库存表：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `storage_tbl` (</span><br><span class="line">  `id` int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `commodity_code` varchar(255) DEFAULT NULL COMMENT &#x27;商品码&#x27;,</span><br><span class="line">  `count` int(11) unsigned DEFAULT &#x27;0&#x27; COMMENT &#x27;商品库存&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`) USING BTREE,</span><br><span class="line">  UNIQUE KEY `commodity_code` (`commodity_code`) USING BTREE</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8 ROW_FORMAT=COMPACT;</span><br></pre></td></tr></table></figure>

<p>用户账户表：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `account_tbl` (</span><br><span class="line">  `id` int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `user_id` varchar(255) DEFAULT NULL COMMENT &#x27;用户id&#x27;,</span><br><span class="line">  `money` int(11) unsigned DEFAULT &#x27;0&#x27; COMMENT &#x27;用户余额&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`) USING BTREE</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8 ROW_FORMAT=COMPACT;</span><br></pre></td></tr></table></figure>

<p>还有用来记录 Seata 中的事务日志表 undo_log，其中会包含<code>after_image</code>和<code>before_image</code>数据，用于数据回滚：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `undo_log` (</span><br><span class="line">  `id` bigint(20) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `branch_id` bigint(20) NOT NULL,</span><br><span class="line">  `xid` varchar(100) NOT NULL,</span><br><span class="line">  `context` varchar(128) NOT NULL,</span><br><span class="line">  `rollback_info` longblob NOT NULL,</span><br><span class="line">  `log_status` int(11) NOT NULL,</span><br><span class="line">  `log_created` datetime NOT NULL,</span><br><span class="line">  `log_modified` datetime NOT NULL,</span><br><span class="line">  `ext` varchar(100) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`) USING BTREE,</span><br><span class="line">  UNIQUE KEY `ux_undo_log` (`xid`,`branch_id`) USING BTREE</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 ROW_FORMAT=COMPACT;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-2-引入-Demo-工程"><a href="#3-2-2-引入-Demo-工程" class="headerlink" title="3.2.2.引入 Demo 工程"></a>3.2.2.引入 Demo 工程</h3><p>我们先准备基本的项目环境，实现下单的业务代码</p>
<h4 id="导入项目"><a href="#导入项目" class="headerlink" title="导入项目"></a>导入项目</h4><p>使用 Idea 打开资料中提供的 seata-demo 项目：</p>
<p><img src="assets/image-20200306170419354.png"></p>
<p>找到项目所在目录，选中并打开：</p>
<p><img src="assets/image-20200306170520985.png"></p>
<p>项目结构如下：</p>
<p><img src="assets/image-20200306171827203.png"></p>
<p>结构说明：</p>
<ul>
<li>account-service：用户服务，提供操作用户账号余额的功能，端口 8083</li>
<li>eureka-server：注册中心，端口 8761</li>
<li>order-service：订单服务，提供根据数据创建订单的功能，端口 8082</li>
<li>storage-service：仓储服务，提供扣减商品库存功能，端口 8081</li>
</ul>
<h4 id="测试事务"><a href="#测试事务" class="headerlink" title="测试事务"></a>测试事务</h4><p>接下来，我们来测试下分布式事务的现象。</p>
<p>下单的接口是：</p>
<ul>
<li>请求方式：POST</li>
<li>请求路径：/order</li>
<li>请求参数：form 表单，包括：<ul>
<li>userId：用户 id</li>
<li>commodityCode：商品码</li>
<li>count：购买数量</li>
<li>money：话费金额</li>
</ul>
</li>
<li>返回值类型：long，订单的 id</li>
</ul>
<p>原始数据库数据：</p>
<p>余额：</p>
<p><img src="assets/image-20200306173439268.png"></p>
<p>库存：</p>
<p><img src="assets/image-20200306173511332.png"></p>
<p>其它两张表为空。</p>
<blockquote>
<p>正常下单</p>
</blockquote>
<p>此时启动项目，尝试下单，目前商品库存为 10，用户余额为 1000，因此只要数据不超过这两个值应该能正常下单。</p>
<p><img src="assets/image-20200306173343839.png"></p>
<p>查看数据库数据：</p>
<p>余额：</p>
<p><img src="assets/image-20200306173602942.png"></p>
<p>库存：</p>
<p><img src="assets/image-20200306173629491.png"></p>
<p>订单：</p>
<p><img src="assets/image-20200306173700813.png"></p>
<blockquote>
<p>异常下单</p>
</blockquote>
<p>这次，我们把 money 参数设置为 1200，这样就超过了余额最大值，理论上所有数据都应该回滚：</p>
<p><img src="assets/image-20200306173916953.png"></p>
<p>看下用户余额：</p>
<p><img src="assets/image-20200306224048175.png"></p>
<p>因为扣款失败，因此这里没有扣减</p>
<p>来看下库存数据：</p>
<p><img src="assets/image-20200306174001901.png"></p>
<p>这说明扣减库存依然成功，并未回滚！</p>
<p>接下来，我们引入 Seata，看看能不能解决这个问题。</p>
<h3 id="3-2-3-准备-TC-服务"><a href="#3-2-3-准备-TC-服务" class="headerlink" title="3.2.3.准备 TC 服务"></a>3.2.3.准备 TC 服务</h3><p>在之前讲解 Seata 原理的时候，我们就聊过，其中包含重要的 3 个角色：</p>
<ul>
<li>TC：事务协调器</li>
<li>TM：事务管理器</li>
<li>RM：资源管理器</li>
</ul>
<p>其中，TC 是一个独立的服务，负责协调各个分支事务，而 TM 和 RM 通过 jar 包的方式，集成在各个事务参与者中。</p>
<p>因此，首先我们需要搭建一个独立的 TC 服务。</p>
<h4 id="1）安装"><a href="#1）安装" class="headerlink" title="1）安装"></a>1）安装</h4><p>首先去官网下载 TC 的服务端安装包，GitHub 的地址：<a target="_blank" rel="noopener" href="https://github.com/seata/seata/releases">https://github.com/seata/seata/releases</a></p>
<p>这里我们在资料中提供给大家 1.1.0 版本的安装包：</p>
<p><img src="assets/image-20200306174740064.png"></p>
<p>然后解压即可，其目录结构如下：</p>
<p><img src="assets/image-20200306174818712.png"></p>
<p>包括：</p>
<ul>
<li>bin：启动脚本</li>
<li>conf：配置文件</li>
<li>lib：依赖项</li>
<li></li>
</ul>
<h4 id="2）配置"><a href="#2）配置" class="headerlink" title="2）配置"></a>2）配置</h4><p>Seata 的核心配置主要是两部分：</p>
<ul>
<li>注册中心的配置：在<code>$&#123;seata_home&#125;/conf/</code>目录中，一般是<code>registry.conf</code>文件</li>
<li>当前服务的配置，两种配置方式：<ul>
<li>通过分布式服务的统一配置中心，例如 Zookeeper</li>
<li>通过本地文件</li>
</ul>
</li>
</ul>
<p>我们先看 registry.conf，内容是 JSON 风格</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">registry <span class="punctuation">&#123;</span></span><br><span class="line">  # 指定注册中心类型，这里使用eureka类型</span><br><span class="line">  type = <span class="string">&quot;eureka&quot;</span></span><br><span class="line">  # 各种注册中心的配置。。这里省略，只保留了eureka和Zookeeper</span><br><span class="line">  eureka <span class="punctuation">&#123;</span></span><br><span class="line">    serviceUrl = <span class="string">&quot;http://localhost:8761/eureka&quot;</span></span><br><span class="line">    application = <span class="string">&quot;seata_tc_server&quot;</span></span><br><span class="line">    weight = <span class="string">&quot;1&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  zk <span class="punctuation">&#123;</span></span><br><span class="line">    cluster = <span class="string">&quot;default&quot;</span></span><br><span class="line">    serverAddr = <span class="string">&quot;127.0.0.1:2181&quot;</span></span><br><span class="line">    session.timeout = <span class="number">6000</span></span><br><span class="line">    connect.timeout = <span class="number">2000</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">config <span class="punctuation">&#123;</span></span><br><span class="line">  # 配置文件方式，可以支持 file、nacos 、apollo、zk、consul、etcd3</span><br><span class="line">  type = <span class="string">&quot;file&quot;</span></span><br><span class="line">  nacos <span class="punctuation">&#123;</span></span><br><span class="line">    serverAddr = <span class="string">&quot;localhost&quot;</span></span><br><span class="line">    namespace = <span class="string">&quot;&quot;</span></span><br><span class="line">    group = <span class="string">&quot;SEATA_GROUP&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  zk <span class="punctuation">&#123;</span></span><br><span class="line">    serverAddr = <span class="string">&quot;127.0.0.1:2181&quot;</span></span><br><span class="line">    session.timeout = <span class="number">6000</span></span><br><span class="line">    connect.timeout = <span class="number">2000</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  file <span class="punctuation">&#123;</span></span><br><span class="line">    name = <span class="string">&quot;file.conf&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>这个文件主要配置两个内容：</p>
<ul>
<li>注册中心的类型及地址，本例我们选择 eureka 做注册中心<ul>
<li>eureka.serviceUrl：是 eureka 的地址，例如 <a target="_blank" rel="noopener" href="http://localhost:8761/eureka">http://localhost:8761/eureka</a></li>
<li>application：是 TC 注册到 eureka 时的服务名称，例如<code>seata_tc_server</code></li>
</ul>
</li>
<li>配置中心的类型及地址，本例我们选择本地文件做配置，就是当前目录的<code>file.conf</code>文件</li>
</ul>
<p>再来看<code>file.conf</code>文件：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## transaction log store<span class="punctuation">,</span> only used in seata-server</span><br><span class="line">store <span class="punctuation">&#123;</span></span><br><span class="line">  ## store mode<span class="punctuation">:</span> file、db</span><br><span class="line">  mode = <span class="string">&quot;file&quot;</span></span><br><span class="line">  ## file store property</span><br><span class="line">  file <span class="punctuation">&#123;</span></span><br><span class="line">    ## store location dir</span><br><span class="line">    dir = <span class="string">&quot;sessionStore&quot;</span></span><br><span class="line">    # branch session size <span class="punctuation">,</span> if exceeded first try compress lockkey<span class="punctuation">,</span> still exceeded throws exceptions</span><br><span class="line">    maxBranchSessionSize = <span class="number">16384</span></span><br><span class="line">    # globe session size <span class="punctuation">,</span> if exceeded throws exceptions</span><br><span class="line">    maxGlobalSessionSize = <span class="number">512</span></span><br><span class="line">    # file buffer size <span class="punctuation">,</span> if exceeded allocate new buffer</span><br><span class="line">    fileWriteBufferCacheSize = <span class="number">16384</span></span><br><span class="line">    # when recover batch read size</span><br><span class="line">    sessionReloadReadSize = <span class="number">100</span></span><br><span class="line">    # async<span class="punctuation">,</span> sync</span><br><span class="line">    flushDiskMode = async</span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">  ## database store property</span><br><span class="line">  db <span class="punctuation">&#123;</span></span><br><span class="line">    ## the implement of javax.sql.DataSource<span class="punctuation">,</span> such as DruidDataSource(druid)/BasicDataSource(dbcp) etc.</span><br><span class="line">    datasource = <span class="string">&quot;dbcp&quot;</span></span><br><span class="line">    ## mysql/oracle/h2/oceanbase etc.</span><br><span class="line">    dbType = <span class="string">&quot;mysql&quot;</span></span><br><span class="line">    driverClassName = <span class="string">&quot;com.mysql.jdbc.Driver&quot;</span></span><br><span class="line">    url = <span class="string">&quot;jdbc:mysql://127.0.0.1:3306/seata_demo&quot;</span></span><br><span class="line">    user = <span class="string">&quot;root&quot;</span></span><br><span class="line">    password = <span class="string">&quot;123&quot;</span></span><br><span class="line">    minConn = <span class="number">1</span></span><br><span class="line">    maxConn = <span class="number">10</span></span><br><span class="line">    globalTable = <span class="string">&quot;global_table&quot;</span></span><br><span class="line">    branchTable = <span class="string">&quot;branch_table&quot;</span></span><br><span class="line">    lockTable = <span class="string">&quot;lock_table&quot;</span></span><br><span class="line">    queryLimit = <span class="number">100</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>关键配置：</p>
<ul>
<li>store：TC 的服务端数据存储配置<ul>
<li>mode：数据存储方式，支持两种：file 和 db<ul>
<li>file：将数据存储在本地文件中，性能比较好，但不支持水平扩展</li>
<li>db：将数据保存在指定的数据库中，需要指定数据库连接信息</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>如果用文件作为存储介质，不需要其它配置了，直接运行即可。</p>
<p>但是如果使用 db 作为存储介质，还需要在数据库中创建 3 张表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `global_table`</span><br><span class="line">(</span><br><span class="line">    `xid`                       <span class="type">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `transaction_id`            <span class="type">BIGINT</span>,</span><br><span class="line">    `status`                    TINYINT      <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `application_id`            <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">    `transaction_service_group` <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">    `transaction_name`          <span class="type">VARCHAR</span>(<span class="number">128</span>),</span><br><span class="line">    `timeout`                   <span class="type">INT</span>,</span><br><span class="line">    `begin_time`                <span class="type">BIGINT</span>,</span><br><span class="line">    `application_data`          <span class="type">VARCHAR</span>(<span class="number">2000</span>),</span><br><span class="line">    `gmt_create`                DATETIME,</span><br><span class="line">    `gmt_modified`              DATETIME,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`xid`),</span><br><span class="line">    KEY `idx_gmt_modified_status` (`gmt_modified`, `status`),</span><br><span class="line">    KEY `idx_transaction_id` (`transaction_id`)</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB</span><br><span class="line">  <span class="keyword">DEFAULT</span> CHARSET <span class="operator">=</span> utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- the table to store BranchSession data</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `branch_table`</span><br><span class="line">(</span><br><span class="line">    `branch_id`         <span class="type">BIGINT</span>       <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `xid`               <span class="type">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `transaction_id`    <span class="type">BIGINT</span>,</span><br><span class="line">    `resource_group_id` <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">    `resource_id`       <span class="type">VARCHAR</span>(<span class="number">256</span>),</span><br><span class="line">    `branch_type`       <span class="type">VARCHAR</span>(<span class="number">8</span>),</span><br><span class="line">    `status`            TINYINT,</span><br><span class="line">    `client_id`         <span class="type">VARCHAR</span>(<span class="number">64</span>),</span><br><span class="line">    `application_data`  <span class="type">VARCHAR</span>(<span class="number">2000</span>),</span><br><span class="line">    `gmt_create`        DATETIME,</span><br><span class="line">    `gmt_modified`      DATETIME,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`branch_id`),</span><br><span class="line">    KEY `idx_xid` (`xid`)</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB</span><br><span class="line">  <span class="keyword">DEFAULT</span> CHARSET <span class="operator">=</span> utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- the table to store lock data</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `lock_table`</span><br><span class="line">(</span><br><span class="line">    `row_key`        <span class="type">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `xid`            <span class="type">VARCHAR</span>(<span class="number">96</span>),</span><br><span class="line">    `transaction_id` <span class="type">BIGINT</span>,</span><br><span class="line">    `branch_id`      <span class="type">BIGINT</span>       <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `resource_id`    <span class="type">VARCHAR</span>(<span class="number">256</span>),</span><br><span class="line">    `table_name`     <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">    `pk`             <span class="type">VARCHAR</span>(<span class="number">36</span>),</span><br><span class="line">    `gmt_create`     DATETIME,</span><br><span class="line">    `gmt_modified`   DATETIME,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`row_key`),</span><br><span class="line">    KEY `idx_branch_id` (`branch_id`)</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB</span><br><span class="line">  <span class="keyword">DEFAULT</span> CHARSET <span class="operator">=</span> utf8;</span><br></pre></td></tr></table></figure>

<h4 id="3）启动"><a href="#3）启动" class="headerlink" title="3）启动"></a>3）启动</h4><p>进入<code>$&#123;seata_home&#125;/bin/</code>目录中:</p>
<p><img src="assets/image-20200306201749660.png"></p>
<p>如果是 linux 环境（要有 JRE），执行<code>seata-server.sh</code></p>
<p>如果是 windows 环境，执行<code>seata-server.bat</code></p>
<h3 id="3-2-4-改造-Order-服务"><a href="#3-2-4-改造-Order-服务" class="headerlink" title="3.2.4.改造 Order 服务"></a>3.2.4.改造 Order 服务</h3><p>接下来是微服务的改造，不管是哪一个微服务，只要是事务的参与者，步骤基本一致。</p>
<h4 id="1）引入依赖"><a href="#1）引入依赖" class="headerlink" title="1）引入依赖"></a>1）引入依赖</h4><p>我们在父工程<code>seata-demo</code>中已经对依赖做了管理：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">alibaba.seata.version</span>&gt;</span>2.1.0.RELEASE<span class="tag">&lt;/<span class="name">alibaba.seata.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">seata.version</span>&gt;</span>1.1.0<span class="tag">&lt;/<span class="name">seata.version</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>因此，我们在项目<code>order-service</code>的 pom 文件中，引入依赖坐标即可：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-seata<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;alibaba.seata.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>seata-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.seata<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>seata-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.seata<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;seata.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="2）添加配置文件"><a href="#2）添加配置文件" class="headerlink" title="2）添加配置文件"></a>2）添加配置文件</h4><p>首先在 application.yml 中添加一行配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">alibaba:</span></span><br><span class="line">      <span class="attr">seata:</span></span><br><span class="line">        <span class="attr">tx-service-group:</span> <span class="string">test_tx_group</span> <span class="comment"># 定义事务组的名称</span></span><br></pre></td></tr></table></figure>

<p>这里是定义事务组的名称，接下来会用到。</p>
<p>然后是在<code>resources</code>目录下放两个配置文件：<code>file.conf</code>和<code>registry.conf</code></p>
<p>其中，<code>registry.conf</code>与 TC 服务端的一样，此处不再讲解。</p>
<p>我们来看下<code>file.conf</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">transport <span class="punctuation">&#123;</span></span><br><span class="line">  # tcp udt unix-domain-socket</span><br><span class="line">  type = <span class="string">&quot;TCP&quot;</span></span><br><span class="line">  #NIO NATIVE</span><br><span class="line">  server = <span class="string">&quot;NIO&quot;</span></span><br><span class="line">  #enable heartbeat</span><br><span class="line">  heartbeat = <span class="keyword">true</span></span><br><span class="line">  # the client batch send request enable</span><br><span class="line">  enableClientBatchSendRequest = <span class="keyword">true</span></span><br><span class="line">  #thread factory for netty</span><br><span class="line">  threadFactory <span class="punctuation">&#123;</span></span><br><span class="line">    bossThreadPrefix = <span class="string">&quot;NettyBoss&quot;</span></span><br><span class="line">    workerThreadPrefix = <span class="string">&quot;NettyServerNIOWorker&quot;</span></span><br><span class="line">    serverExecutorThread-prefix = <span class="string">&quot;NettyServerBizHandler&quot;</span></span><br><span class="line">    shareBossWorker = <span class="keyword">false</span></span><br><span class="line">    clientSelectorThreadPrefix = <span class="string">&quot;NettyClientSelector&quot;</span></span><br><span class="line">    clientSelectorThreadSize = <span class="number">1</span></span><br><span class="line">    clientWorkerThreadPrefix = <span class="string">&quot;NettyClientWorkerThread&quot;</span></span><br><span class="line">    # netty boss thread size<span class="punctuation">,</span>will not be used for UDT</span><br><span class="line">    bossThreadSize = <span class="number">1</span></span><br><span class="line">    #auto default pin or <span class="number">8</span></span><br><span class="line">    workerThreadSize = <span class="string">&quot;default&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  shutdown <span class="punctuation">&#123;</span></span><br><span class="line">    # when destroy server<span class="punctuation">,</span> wait seconds</span><br><span class="line">    wait = <span class="number">3</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  serialization = <span class="string">&quot;seata&quot;</span></span><br><span class="line">  compressor = <span class="string">&quot;none&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">service <span class="punctuation">&#123;</span></span><br><span class="line">  vgroup_mapping.test_tx_group = <span class="string">&quot;seata_tc_server&quot;</span></span><br><span class="line">  #only support when registry.type=file<span class="punctuation">,</span> please don&#x27;t set multiple addresses</span><br><span class="line">  seata_tc_server.grouplist = <span class="string">&quot;127.0.0.1:8091&quot;</span></span><br><span class="line">  #degrade<span class="punctuation">,</span> current not support</span><br><span class="line">  enableDegrade = <span class="keyword">false</span></span><br><span class="line">  #disable seata</span><br><span class="line">  disableGlobalTransaction = <span class="keyword">false</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">client <span class="punctuation">&#123;</span></span><br><span class="line">  rm <span class="punctuation">&#123;</span></span><br><span class="line">    asyncCommitBufferLimit = <span class="number">10000</span></span><br><span class="line">    lock <span class="punctuation">&#123;</span></span><br><span class="line">      retryInterval = <span class="number">10</span></span><br><span class="line">      retryTimes = <span class="number">30</span></span><br><span class="line">      retryPolicyBranchRollbackOnConflict = <span class="keyword">true</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">    reportRetryCount = <span class="number">5</span></span><br><span class="line">    tableMetaCheckEnable = <span class="keyword">false</span></span><br><span class="line">    reportSuccessEnable = <span class="keyword">false</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  tm <span class="punctuation">&#123;</span></span><br><span class="line">    commitRetryCount = <span class="number">5</span></span><br><span class="line">    rollbackRetryCount = <span class="number">5</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  undo <span class="punctuation">&#123;</span></span><br><span class="line">    dataValidation = <span class="keyword">true</span></span><br><span class="line">    logSerialization = <span class="string">&quot;jackson&quot;</span></span><br><span class="line">    logTable = <span class="string">&quot;undo_log&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  log <span class="punctuation">&#123;</span></span><br><span class="line">    exceptionRate = <span class="number">100</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>配置解读：</p>
<ul>
<li><code>transport</code>：与 TC 交互的一些配置<ul>
<li><code>heartbeat</code>：client 和 server 通信心跳检测开关</li>
<li><code>enableClientBatchSendRequest</code>：客户端事务消息请求是否批量合并发送</li>
</ul>
</li>
<li><code>service</code>：TC 的地址配置，用于获取 TC 的地址<ul>
<li><code>vgroup_mapping.test_tx_group = &quot;seata_tc_server&quot;</code>：<ul>
<li><code>test_tx_group</code>：是事务组名称，要与 application.yml 中配置一致，</li>
<li><code>seata_tc_server</code>：是 TC 服务端在注册中心的 id，将来通过注册中心获取 TC 地址</li>
<li><code>enableDegrade</code>：服务降级开关，默认关闭。如果开启，当业务重试多次失败后会放弃全局事务</li>
<li><code>disableGlobalTransaction</code>：全局事务开关，默认 false。false 为开启，true 为关闭</li>
</ul>
</li>
<li><code>default.grouplist</code>：这个当注册中心为 file 的时候，才用到</li>
</ul>
</li>
<li><code>client</code>：客户端配置<ul>
<li><code>rm</code>：资源管理器配<ul>
<li><code>asynCommitBufferLimit</code>：二阶段提交默认是异步执行，这里指定异步队列的大小</li>
<li><code>lock</code>：全局锁配置<ul>
<li><code>retryInterval</code>：校验或占用全局锁重试间隔，默认 10，单位毫秒</li>
<li><code>retryTimes</code>：校验或占用全局锁重试次数，默认 30 次</li>
<li><code>retryPolicyBranchRollbackOnConflict</code>：分支事务与其它全局回滚事务冲突时锁策略，默认 true，优先释放本地锁让回滚成功</li>
</ul>
</li>
<li><code>reportRetryCount</code>：一阶段结果上报 TC 失败后重试次数，默认 5 次</li>
</ul>
</li>
<li><code>tm</code>：事务管理器配置<ul>
<li><code>commitRetryCount</code>：一阶段全局提交结果上报 TC 重试次数，默认 1</li>
<li><code>rollbackRetryCount</code>：一阶段全局回滚结果上报 TC 重试次数，默认 1</li>
</ul>
</li>
<li><code>undo</code>：undo_log 的配置<ul>
<li><code>dataValidation</code>：是否开启二阶段回滚镜像校验，默认 true</li>
<li><code>logSerialization</code>：undo 序列化方式，默认 Jackson</li>
<li><code>logTable</code>：自定义 undo 表名，默认是<code>undo_log</code></li>
</ul>
</li>
<li><code>log</code>：日志配置<ul>
<li><code>exceptionRate</code>：出现回滚异常时的日志记录频率，默认 100，百分之一概率。回滚失败基本是脏数据，无需输出堆栈占用硬盘空间</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="3）代理-DataSource"><a href="#3）代理-DataSource" class="headerlink" title="3）代理 DataSource"></a>3）代理 DataSource</h4><p>Seata 的二阶段执行是通过拦截 sql 语句，分析语义来指定回滚策略，因此需要对 DataSource 做代理。我们在项目的<code>cn.itcast.order.config</code>包中，添加一个配置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.order.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.spring.MybatisSqlSessionFactoryBean;</span><br><span class="line"><span class="keyword">import</span> io.seata.rm.datasource.DataSourceProxy;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourceProxyConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SqlSessionFactory <span class="title function_">sqlSessionFactoryBean</span><span class="params">(DataSource dataSource)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 订单服务中引入了mybatis-plus，所以要使用特殊的SqlSessionFactoryBean</span></span><br><span class="line">        <span class="type">MybatisSqlSessionFactoryBean</span> <span class="variable">sqlSessionFactoryBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisSqlSessionFactoryBean</span>();</span><br><span class="line">        <span class="comment">// 代理数据源</span></span><br><span class="line">        sqlSessionFactoryBean.setDataSource(<span class="keyword">new</span> <span class="title class_">DataSourceProxy</span>(dataSource));</span><br><span class="line">        <span class="comment">// 生成SqlSessionFactory</span></span><br><span class="line">        <span class="keyword">return</span> sqlSessionFactoryBean.getObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意，这里因为订单服务使用了 mybatis-plus 这个框架（这是一个 mybatis 集成框架，自动生成单表 Sql），因此我们需要用 mybatis-plus 的<code>MybatisSqlSessionFactoryBean</code>代替<code>SqlSessionFactoryBean</code></p>
<p>如果用的是原生的 mybatis，请使用<code>SqlSessionFactoryBean</code>。</p>
<h4 id="4）添加事务注解"><a href="#4）添加事务注解" class="headerlink" title="4）添加事务注解"></a>4）添加事务注解</h4><p>给事务发起者<code>order_service</code>的<code>OrderServiceImpl</code>中的<code>createOrder()</code>方法添加<code>@GlobalTransactional</code>注解，开启全局事务：</p>
<p><img src="assets/image-20200306223043452.png"></p>
<p>重新启动即可。</p>
<h3 id="3-2-5-改造-Storage、Account-服务"><a href="#3-2-5-改造-Storage、Account-服务" class="headerlink" title="3.2.5.改造 Storage、Account 服务"></a>3.2.5.改造 Storage、Account 服务</h3><p>与 OrderService 类似，这里也要经过下面的步骤：</p>
<ul>
<li>引入依赖：与 order-service 一致，略</li>
<li>添加配置文件：与 order-service 一致，略</li>
<li>代理 DataSource，我们的 storage-service 和 account-service 都没有用 mybatis-plus，所以配置要使用 SqlSessionFactory：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.order.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.seata.rm.datasource.DataSourceProxy;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactory;</span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.SqlSessionFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourceProxyConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SqlSessionFactory <span class="title function_">sqlSessionFactoryBean</span><span class="params">(DataSource dataSource)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 因为使用的是mybatis，这里定义SqlSessionFactoryBean</span></span><br><span class="line">        <span class="type">SqlSessionFactoryBean</span> <span class="variable">sqlSessionFactoryBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBean</span>();</span><br><span class="line">        <span class="comment">// 配置数据源代理</span></span><br><span class="line">        sqlSessionFactoryBean.setDataSource(<span class="keyword">new</span> <span class="title class_">DataSourceProxy</span>(dataSource));</span><br><span class="line">        <span class="keyword">return</span> sqlSessionFactoryBean.getObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外，事务注解可以使用<code>@Transactionnal</code>，而不是<code>@GlobalTransactional</code>，事务发起者才需要添加<code>@GlobalTransactional</code>。</p>
<h3 id="3-2-6-测试"><a href="#3-2-6-测试" class="headerlink" title="3.2.6.测试"></a>3.2.6.测试</h3><p>重启所有微服务后，我们再次测试。</p>
<p>目前数据情况：用户余额 900，库存为 6.</p>
<p>我们试试扣款 1200 元，那么扣款失败，理论上来说所有数据都会回滚.</p>
<p><img src="assets/image-20200306173916953.png"></p>
<p>看下用户余额：</p>
<p><img src="assets/image-20200306224048175.png"></p>
<p>因为扣款失败，因此这里没有扣减</p>
<p>来看下库存数据：</p>
<p><img src="assets/image-20200306174001901.png"></p>
<p>减库存依然是 6，成功回滚，说明分布式事务生效了！</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/13/yuque/%E5%8D%95%E6%92%AD%E7%BB%84%E6%92%AD%E4%B8%8E%E5%B9%BF%E6%92%AD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/13/yuque/%E5%8D%95%E6%92%AD%E7%BB%84%E6%92%AD%E4%B8%8E%E5%B9%BF%E6%92%AD/" class="post-title-link" itemprop="url">单播组播与广播</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-10-13 00:21:44" itemprop="dateCreated datePublished" datetime="2022-10-13T00:21:44+08:00">2022-10-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-02-07 21:27:20" itemprop="dateModified" datetime="2023-02-07T21:27:20+08:00">2023-02-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="组播"><a href="#组播" class="headerlink" title="组播"></a>组播</h1><p>组播是主机间一对多的通讯模式， 组播是一种允许一个或多个组播源发送同一报文到多个接收者的技术。组播源将一份报文发送到特定的组播地址，组播地址不同于单播地址，它并不属于特定某个主机，而是属于一组主机。一个组播地址表示一个群组，需要接收组播报文的接收者都加入这个群组。</p>
<h1 id="单播"><a href="#单播" class="headerlink" title="单播"></a>单播</h1><p>单播是主机间一对一的通讯模式，网络中的设备根据网络报文中包含的目的地址选择传输路径，将单播报文传送到指定的目的地，只对接收到的数据进行转发，不会进行复制。它能够针对每台主机及时的响应，现在的网页浏览全部都是采用单播模式。<br><img src="https://cdn.jsdelivr.net/gh/heheii/blog-imag/blog-images/FtpQTBtFGlhKzQyFBR14oCsNtv__.png"></p>
<h1 id="广播"><a href="#广播" class="headerlink" title="广播"></a>广播</h1><p>广播是主机间一对所有的通讯模式，设备会将报文发送到网络中的所有可能接收者。设备简单地将它收到的任何广播报文都复制并转发到除该报文到达的接口外的每个接口。广播处理流程简单，不用选择路径。<br><img src="https://cdn.jsdelivr.net/gh/heheii/blog-imag/blog-images/Fgg4vH1F0y4pJKHtHXGwkro6fehN.png"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/06/yuque/Flink/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/06/yuque/Flink/" class="post-title-link" itemprop="url">Flink</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-06-06 17:24:38" itemprop="dateCreated datePublished" datetime="2022-06-06T17:24:38+08:00">2022-06-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-02-07 21:27:57" itemprop="dateModified" datetime="2023-02-07T21:27:57+08:00">2023-02-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="什么是-Flink？"><a href="#什么是-Flink？" class="headerlink" title="什么是 Flink？"></a>什么是 Flink？</h1><p><img src="https://cdn.jsdelivr.net/gh/heheii/blog-imag/blog-images/FsMXaK8CDlh7GUK63ySHXyL3kfQP.png"></p>
<blockquote>
<p>Flink 是一个分布式的计算处理引擎</p>
</blockquote>
<ul>
<li>分布式：「它的存储或者计算交由多台服务器上完成，最后汇总起来达到最终的效果」。</li>
<li>实时：处理速度是毫秒级或者秒级的</li>
<li>计算：可以简单理解为对数据进行处理，比如清洗数据（对数据进行规整，取出有用的数据）</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/heheii/blog-imag/blog-images/FlN2MKtjO6zhQqAB13MsjFggsWjd.png"></p>
<p>基于官网的一句话介绍，我们就可以联想出很多东西。</p>
<p>这篇文章可以带你简单认识一下 Flink 的一些基础概念，等你真正用到的时候就可以依据这篇文章来对 Flink 进行入门，现在 Storm 都被很多人给抛弃掉了，那么 Flink 优于 Storm 的地方有哪些呢？接下来我们一起来看看 Flink 吧。</p>
<p>什么是有边界和无边界？<br>Apache Flink 是一个框架和分布式处理引擎，用于在无边界和有边界数据流上进行有状态的计算。</p>
<p>官方其实也有介绍，但对初学者来说不太好理解，我来幼儿园化一下。</p>
<p>大家学到 Flink 了，消息队列肯定有用过吧？那你们是怎么用消息队列的呢？Producer 生产数据，发给 Broker，Consumer 消费，完事。</p>
<p>在消费的时候，我们需要管什么 Producer 什么时候发消息吗？不需要吧。反正来一条，我就处理一条，没毛病吧。</p>
<p>这种没有做任何处理的消息，默认就是无边界的。</p>
<p>那有边界就很好理解了：无边界的基础上加上条件，那就是有边界的。加什么条件呢？比如我要加个时间：我要消费从 8 月 8 号到 8 月 9 号的数据，那就是有边界的。</p>
<p><img src="https://cdn.jsdelivr.net/gh/heheii/blog-imag/blog-images/Fjh-5bduezp6zuvNVIAnjSnRYHTQ.png"></p>
<p>什么时候用无边界，什么时候用有边界？那也很好理解。我做数据清洗：来一条，我处理一条，这种无边界的就好了。我要做数据统计：每个小时的 pv(page view)是多少，那我就设置 1 小时的边界，攒着一小时的数据来处理一次。</p>
<p>在 Flink 上，设置“边界”这种操作叫做开窗口(Windows)，窗口可简单分为两种类型：</p>
<p>时间窗口(TimeWindows)：按照时间窗口进行聚合，比如上面所讲得攥着一个小时的数据处理一次。<br>计数窗口(CountWindows)：按照指定的条数来进行聚合，比如每来了 10 条数据处理一次。<br>看着就非常人性化（妈妈再也不用担心我需要聚合了）…</p>
<p>不仅如此，在 Flink 使用窗口聚合的时候，还考虑到了数据的准确性问题。比如说：现在我在 11:06 分产生了 5 条数据，在 11:07 分 产生了 4 条数据，我现在是按每分钟的维度来进行聚合计算。</p>
<p>理论上来讲：Flink 应该是在 06 分聚合了 5 条数据，在 07 分聚合了 4 条数据。但是，可能由于网络的延迟性等原因，导致 06 分的 3 条数据在 07 分时 Flink 才接收到。如果不做任何处理，那 07 分有可能处理了 7 条条数据。</p>
<p>某些需要准确结果的场景来说，这就不太合理了。所以 Flink 可以给我们指定”时间语义“，不指定默认是「数据到 Flink 的时间」Processing Time 来进行聚合处理，可以给我们指定聚合的时间以「事件发生的时间」Event Time 来进行处理。</p>
<p>事件发生的时间指的就是：日志真正记录的时间</p>
<p>2020-11-22 00:00:02.552 INFO [http-nio-7001-exec-28] c.m.t.rye.admin.web.aop.LogAspect</p>
<p>虽然指定了聚合的时间为「事件发生的时间」Event Time，但还是没解决数据乱序的问题（06 分产生了 5 条数据，实际上 06 分只收到了 3 条，而剩下的两条在 07 分才收到，那此时怎么办呢？在 06 分时该不该聚合，07 分收到的两条 06 分数据怎么办？）</p>
<p>Flink 又可以给我们设置水位线(waterMarks)，Flink 意思就是：存在网络延迟等情况导致数据接收不是有序，这种情况我都能理解。你这样吧，根据自身的情况，你可以设置一个「延迟时间」，等延迟的时间到了，我再聚合统一聚合。</p>
<p>比如说：现在我知道数据有可能会延迟一分钟，那我将水位线 waterMarks 设置延迟一分钟。</p>
<p>解读：因为设置了「事件发生的时间」Event Time，所以 Flink 可以检测到每一条记录发生的时间，而设置了水位线 waterMarks 设置延迟一分钟，等到 Flink 发现 07 分:59 秒的数据来到了 Flink，那就确信 06 分的数据都来了（因为设置了 1 分钟延迟），此时才聚合 06 分的窗口数据。<br><img src="https://cdn.jsdelivr.net/gh/heheii/blog-imag/blog-images/FhjQsjN32C23P8CMvyPy43wfZ-_z.png"></p>
<p>什么叫做有状态？<br>Apache Flink 是一个框架和分布式处理引擎，用于在无边界和有边界数据流上进行有状态的计算。</p>
<p>什么是有状态，什么是无状态？</p>
<p>无状态我们可以简单认为：每次的执行都不依赖上一次或上 N 次的执行结果，每次的执行都是独立的。</p>
<p>有状态我们可以简单认为：执行需要依赖上一次或上 N 次的执行结果，某次的执行需要依赖前面事件的处理结果。</p>
<p><img src="https://cdn.jsdelivr.net/gh/heheii/blog-imag/blog-images/FpXP4P-sPKZmqmPSqkjFaYCwGvIY.png"></p>
<p>比如，我们现在要统计文章的阅读 PV(page view)，现在只要有一个点击了文章，在 Kafka 就会有一条消息。现在我要在流式处理平台上进行统计，那此时是有状态的还是无状态的？</p>
<p>假设我们要在 Storm 做，那我们可能将每次的处理结果放到一个“外部存储”中，然后基于这个“外部存储”进行计算（这里我们不用 Storm Trident），那此时 Storm 是无状态的。</p>
<p>比如说：我存储将每次得到的数据存储到 Redis 中，来一条数据，我就先查一下 Redis 目前的值是多少，跟 Redis 的值和现在的值做一次累加就完事了。</p>
<p>假设要在 Flink 做，Flink 本身就提供了这种功能给我们使用，我们可以依赖 Flink 的“存储”，将每次的处理结果交由 Flink 管理，执行计算的逻辑。</p>
<p><img src="https://cdn.jsdelivr.net/gh/heheii/blog-imag/blog-images/FglSUY0o61_9VvDAmWaWztxTRVuP.png"></p>
<p>可以简单的认为：Flink 本身就给我们提供了”存储“的功能，而我们每次执行是可以依赖 Flink 的”存储”的，所以它是有状态的。</p>
<p><img src="https://cdn.jsdelivr.net/gh/heheii/blog-imag/blog-images/FonrqiZmSLLQ5T2E8NqHfZsdwPLT.png"></p>
<p>那 Flink 是把这些有状态的数据存储在哪的呢？</p>
<p>主要有三个地方：</p>
<p>内存<br>文件系统（HDFS）<br>本地数据库<br><img src="https://cdn.jsdelivr.net/gh/heheii/blog-imag/blog-images/FiOhgdp8w34okCfvMhvOfNZ862Rr.png"><br><img src="https://cdn.jsdelivr.net/gh/heheii/blog-imag/blog-images/FhMRqt7c0S_frH2_T8HeXMXDC5Nf.png"></p>
<p>如果假设 Flink 挂了，可能内存的数据没了，磁盘可能存储了部分的数据，那再重启的时候（比如消息队列会重新拉取），就不怕会丢了或多了数据吗？</p>
<p>看到这里，你可能在会在别的地方看过 Flink 的另外一个比较出名的特性：精确一次性</p>
<p>（简单来说就是：Flink 遇到意外事件挂了以后，有什么机制来尽可能保证处理数据不重复和不丢失的呢）</p>
<p>什么是精确一次性（exactly once）？<br>众所周知，流的语义性有三种：</p>
<p>精确一次性（exactly once）：有且只有一条，不多不少<br>至少一次（at least once）：最少会有一条，只多不少<br>最多一次（at most once）：最多只有一条，可能会没有<br>Flink 实现了精确一次性，这个精确一次性是什么意思呢？</p>
<p>Flink 的精确一次性指的是：状态只持久化一次到最终的存储介质中（本地数据库/HDFS…)<br><img src="https://cdn.jsdelivr.net/gh/heheii/blog-imag/blog-images/Fo_Iq0AlOjuz-x5gIVZc3Z2uPiV0.png"></p>
<p>以上面的图为例：Source 数据流有以下数字 21,13,8,5,3,2,1,1，然后在 Flink 需要做累加操作（求和）</p>
<p>现在处理完 2,1,1 了，所以累加的值是 4，现在 Flink 把累积后的状态 4 已经存储起来了（认为前面 2,1,1 这几个数字已经完全处理过了）。</p>
<p>程序一直往下走，处理了 5,3，现在累加的值是 12，但现在 Flink 还没来得及把 12 存储到最终的介质，此时系统挂掉了。</p>
<p>Flink 重启后会重新把系统恢复到累加的值是 4 的状态，所以 5,3 得继续计算一遍，程序继续往下走。</p>
<p>看文章有的同学可能会认为：精确一次性指的不是某一段代码只会执行一次，不会执行多次或不执行。这 5 和 3 这两个数，你不是重复计算了吗？怎么就精确一次了？</p>
<p>显然，代码只执行一次肯定是不可能的嘛。我们无法控制系统在哪一行代码挂掉的，你要是在挂的时候，当前方法还没执行完，你还是得重新执行该方法的。</p>
<p>所以，状态只持久化一次到最终的存储介质中（本地数据库/HDFS)，在 Flink 下就叫做 exactly once（计算的数据可能会重复（无法避免），但状态在存储介质上只会存储一次）。</p>
<p>那么 Flink 是在多长时间存储一次的呢？这个是我们自己手动配置的。</p>
<p>所谓的 CheckPoint 其实就是 Flink 会在指定的时间段上保存状态的信息，假设 Flink 挂了可以将上一次状态信息再捞出来，重放还没保存的数据来执行计算，最终实现 exactly once。</p>
<p>那 CheckPonit 是怎么办到的呢？想想我们在 Kafka 在业务上实现「至少一次」是怎么做的？我们从 Kafka 把数据拉下来，处理完业务了以后，手动提交 offset (告诉 Kafka 我已经处理完了)</p>
<p><img src="https://cdn.jsdelivr.net/gh/heheii/blog-imag/blog-images/FgSqiUqPQHcMS7gUXN4oNHZkwIlt.png"></p>
<p>我们是做完了业务规则才将 offset 进行 commit 的，checkponit 其实也是一样的（等拉下来该条数据所有的流程走完，才进行真正的 checkponit）。</p>
<p>问题又来了，那 checkpoint 是怎么知道拉下来的数据已经走完了呢？Flink 在流处理过程中插入了 barrier，每个环节处理到 barrier 都会上报，等到 sink 都上报了 barrier 就说明这次 checkpoint 已经走完了。</p>
<p><img src="https://cdn.jsdelivr.net/gh/heheii/blog-imag/blog-images/FmoyOqoDyVwpKAqg9-pVdap9tA1j.png"></p>
<p>要注意的是，Flink 实现的精确一次性只是保证内部的状态是精确一次的，如果想要端到端精确一次，需要端的支持</p>
<p>数据源需要可回放，发证故障可以重新读取未确认的数据<br>Flink 需要把数据存到磁盘介质（不能用内存），发生故障可以恢复<br>发送源需要支持事务（从读到写需要事务的支持保证中途不失败）</p>
<p>最后<br>这篇文章对 Flink 做了一次简单的介绍，希望对大家在入门的时候有所帮助。后续打算会再写一篇 Flink 文章对 CheckPoint 机制做更加深入的了解，有兴趣的同学可以点个关注第一时间能接收到。<br>————————————————<br>版权声明：本文为 CSDN 博主「Java3y」的原创文章，遵循 CC 4.0 BY-SA 版权协议，转载请附上原文出处链接及本声明。<br>原文链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/Java_3y/article/details/110184903">https://blog.csdn.net/Java_3y/article/details/110184903</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/06/yuque/Hadoop/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/06/yuque/Hadoop/" class="post-title-link" itemprop="url">Hadoop</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-06-06 15:19:11" itemprop="dateCreated datePublished" datetime="2022-06-06T15:19:11+08:00">2022-06-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-02-07 21:27:57" itemprop="dateModified" datetime="2023-02-07T21:27:57+08:00">2023-02-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="三大发行版本"><a href="#三大发行版本" class="headerlink" title="三大发行版本"></a>三大发行版本</h1><ol>
<li>Apache 版本<ol>
<li>最原始（最基础）的版本，对于入门学习最好。</li>
<li>组件兼容性需要自己调研</li>
</ol>
</li>
<li>CDH<ol>
<li>开源</li>
<li>在大型互联网企业中用的较多。</li>
</ol>
</li>
<li>HDP<ol>
<li>开源，可以二次开发</li>
<li>没有 cdh 稳定，使用较少</li>
</ol>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/06/yuque/%E6%8A%80%E6%9C%AF%E6%A0%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/06/yuque/%E6%8A%80%E6%9C%AF%E6%A0%88/" class="post-title-link" itemprop="url">技术栈</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-06-06 14:35:08" itemprop="dateCreated datePublished" datetime="2022-06-06T14:35:08+08:00">2022-06-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-02-07 21:27:57" itemprop="dateModified" datetime="2023-02-07T21:27:57+08:00">2023-02-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <table>
<thead>
<tr>
<th><strong>类别</strong></th>
<th></th>
<th><strong>主流代表技术</strong></th>
</tr>
</thead>
<tbody><tr>
<td>分布式文件系统</td>
<td></td>
<td>Hadoop HDFS</td>
</tr>
<tr>
<td>资源调度与管理</td>
<td></td>
<td>Hadoop YARN 、Kubernetes</td>
</tr>
</tbody></table>
<p>|</p>
<p>分布式计算 | 批处理：特点是有界、持久、大量，非常适合需要访问全套记录才能完成的计算工作，一般用于离线统计。</p>
<p>| MapReduce（中间过程会落盘，慢）<br>Hive<br>Spark |<br>| | 流处理：特点是无界、实时, 无需针对整个数据集执行操作，而是对通过系统传输的每个数据项执行操作，一般用于实时统计。 | Spark Streaming（微批处理）、<br>Flink</p>
<p>|</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">114</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
